<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>modeling-and-viewing-users-one</title>
    <link rel="stylesheet" href="pygments.css" type="text/css" />
    <link rel="stylesheet" href="polytexnic.css" type="text/css" />
  </head>
  <body>
    <div id="book">

<h1 class="title">Ruby on Rails Tutorial </h1>


<h1 class="subtitle">  Learn Rails by Example</h1>


<h2 class="author">Michael Hartl</h2>




<h2 class="contents">Contents</h2>


<div id="table_of_contents"><ol><li class="chapter"><a href="beginning#top"><span class="number">Chapter 1</span> From zero to deploy</a></li><li><ol><li class="section"><a href="beginning#sec-introduction"><span class="number">1.1</span> Introduction</a></li><li><ol><li class="subsection"><a href="beginning#sec-comments_for_various_readers"><span class="number">1.1.1</span> Comments for various readers</a></li><li class="subsection"><a href="beginning#sec-1_1_2"><span class="number">1.1.2</span> &ldquo;Scaling&rdquo; Rails</a></li><li class="subsection"><a href="beginning#sec-conventions"><span class="number">1.1.3</span> Conventions in this book</a></li></ol></li><li class="section"><a href="beginning#sec-up_and_running"><span class="number">1.2</span> Up and running</a></li><li><ol><li class="subsection"><a href="beginning#sec-development_tools"><span class="number">1.2.1</span> Development environments</a></li><li><ol><li class="subsubsection"><a href="beginning#sec-1_2_1_1">IDEs</a></li><li class="subsubsection"><a href="beginning#sec-1_2_1_2">Text editors and command lines</a></li><li class="subsubsection"><a href="beginning#sec-1_2_1_3">Browsers</a></li><li class="subsubsection"><a href="beginning#sec-1_2_1_4">A note about tools</a></li></ol></li><li class="subsection"><a href="beginning#sec-rubygems"><span class="number">1.2.2</span> Ruby, RubyGems, Rails, and Git</a></li><li><ol><li class="subsubsection"><a href="beginning#sec-rails_installer_windows">Rails Installer (Windows)</a></li><li class="subsubsection"><a href="beginning#sec-install_git">Install Git</a></li><li class="subsubsection"><a href="beginning#sec-install_ruby">Install Ruby</a></li><li class="subsubsection"><a href="beginning#sec-install_rubygems">Install RubyGems</a></li><li class="subsubsection"><a href="beginning#sec-install_rails">Install Rails</a></li></ol></li><li class="subsection"><a href="beginning#sec-the_first_application"><span class="number">1.2.3</span> The first application</a></li><li class="subsection"><a href="beginning#sec-bundler"><span class="number">1.2.4</span> Bundler</a></li><li class="subsection"><a href="beginning#sec-rails_server"><span class="number">1.2.5</span> <code>rails server</code></a></li><li class="subsection"><a href="beginning#sec-mvc"><span class="number">1.2.6</span> Model-view-controller (MVC)</a></li></ol></li><li class="section"><a href="beginning#sec-version_control"><span class="number">1.3</span> Version control with Git</a></li><li><ol><li class="subsection"><a href="beginning#sec-git_setup"><span class="number">1.3.1</span> Installation and setup</a></li><li><ol><li class="subsubsection"><a href="beginning#sec-1_3_1_1">First-time system setup</a></li><li class="subsubsection"><a href="beginning#sec-1_3_1_2">First-time repository setup</a></li></ol></li><li class="subsection"><a href="beginning#sec-adding_and_committing"><span class="number">1.3.2</span> Adding and committing</a></li><li class="subsection"><a href="beginning#sec-1_3_3"><span class="number">1.3.3</span> What good does Git do you?</a></li><li class="subsection"><a href="beginning#sec-github"><span class="number">1.3.4</span> GitHub</a></li><li class="subsection"><a href="beginning#sec-git_commands"><span class="number">1.3.5</span> Branch, edit, commit, merge</a></li><li><ol><li class="subsubsection"><a href="beginning#sec-git_branch">Branch</a></li><li class="subsubsection"><a href="beginning#sec-git_edit">Edit</a></li><li class="subsubsection"><a href="beginning#sec-git_commit">Commit</a></li><li class="subsubsection"><a href="beginning#sec-git_merge">Merge</a></li><li class="subsubsection"><a href="beginning#sec-git_push">Push</a></li></ol></li></ol></li><li class="section"><a href="beginning#sec-deploying"><span class="number">1.4</span> Deploying</a></li><li><ol><li class="subsection"><a href="beginning#sec-1_4_1"><span class="number">1.4.1</span> Heroku setup</a></li><li class="subsection"><a href="beginning#sec-heroku_step_one"><span class="number">1.4.2</span> Heroku deployment, step one</a></li><li class="subsection"><a href="beginning#sec-1_4_3"><span class="number">1.4.3</span> Heroku deployment, step two</a></li><li class="subsection"><a href="beginning#sec-heroku_commands"><span class="number">1.4.4</span> Heroku commands</a></li></ol></li><li class="section"><a href="beginning#sec-beginning_conclusion"><span class="number">1.5</span> Conclusion</a></li></ol></li><li class="chapter"><a href="a-demo-app#top"><span class="number">Chapter 2</span> A demo app</a></li><li><ol><li class="section"><a href="a-demo-app#sec-planning_the_application"><span class="number">2.1</span> Planning the application</a></li><li><ol><li class="subsection"><a href="a-demo-app#sec-modeling_users"><span class="number">2.1.1</span> Modeling users</a></li><li class="subsection"><a href="a-demo-app#sec-modeling_microposts"><span class="number">2.1.2</span> Modeling microposts</a></li></ol></li><li class="section"><a href="a-demo-app#sec-demo_users_resource"><span class="number">2.2</span> The Users resource</a></li><li><ol><li class="subsection"><a href="a-demo-app#sec-a_user_tour"><span class="number">2.2.1</span> A user tour</a></li><li class="subsection"><a href="a-demo-app#sec-mvc_in_action"><span class="number">2.2.2</span> MVC in action</a></li><li class="subsection"><a href="a-demo-app#sec-weaknesses_of_this_users_resource"><span class="number">2.2.3</span> Weaknesses of this Users resource</a></li></ol></li><li class="section"><a href="a-demo-app#sec-microposts_resource"><span class="number">2.3</span> The Microposts resource</a></li><li><ol><li class="subsection"><a href="a-demo-app#sec-a_micropost_microtour"><span class="number">2.3.1</span> A micropost microtour</a></li><li class="subsection"><a href="a-demo-app#sec-putting_the_micro_in_microposts"><span class="number">2.3.2</span> Putting the <em>micro</em> in microposts</a></li><li class="subsection"><a href="a-demo-app#sec-demo_user_has_many_microposts"><span class="number">2.3.3</span> A user <code>has_many</code> microposts</a></li><li class="subsection"><a href="a-demo-app#sec-inheritance_hierarchies"><span class="number">2.3.4</span> Inheritance hierarchies</a></li><li class="subsection"><a href="a-demo-app#sec-deploying_the_demo_app"><span class="number">2.3.5</span> Deploying the demo app</a></li></ol></li><li class="section"><a href="a-demo-app#sec-2_4"><span class="number">2.4</span> Conclusion</a></li></ol></li><li class="chapter"><a href="static-pages#top"><span class="number">Chapter 3</span> Mostly static pages</a></li><li><ol><li class="section"><a href="static-pages#sec-static_pages"><span class="number">3.1</span> Static pages</a></li><li><ol><li class="subsection"><a href="static-pages#sec-truly_static_pages"><span class="number">3.1.1</span> Truly static pages</a></li><li class="subsection"><a href="static-pages#sec-static_pages_with_rails"><span class="number">3.1.2</span> Static pages with Rails</a></li></ol></li><li class="section"><a href="static-pages#sec-first_tests"><span class="number">3.2</span> Our first tests</a></li><li><ol><li class="subsection"><a href="static-pages#sec-testing_tools"><span class="number">3.2.1</span> Testing tools</a></li><li><ol><li class="subsubsection"><a href="static-pages#sec-autotest">Autotest</a></li></ol></li><li class="subsection"><a href="static-pages#sec-TDD"><span class="number">3.2.2</span> TDD: Red, Green, Refactor</a></li><li><ol><li class="subsubsection"><a href="static-pages#sec-spork">Spork</a></li><li class="subsubsection"><a href="static-pages#sec-red">Red</a></li><li class="subsubsection"><a href="static-pages#sec-green">Green</a></li><li class="subsubsection"><a href="static-pages#sec-refactor">Refactor</a></li></ol></li></ol></li><li class="section"><a href="static-pages#sec-slightly_dynamic_pages"><span class="number">3.3</span> Slightly dynamic pages</a></li><li><ol><li class="subsection"><a href="static-pages#sec-testing_a_title_change"><span class="number">3.3.1</span> Testing a title change</a></li><li class="subsection"><a href="static-pages#sec-passing_title_tests"><span class="number">3.3.2</span> Passing title tests</a></li><li class="subsection"><a href="static-pages#sec-instance_variables_embedded_ruby"><span class="number">3.3.3</span> Instance variables and Embedded Ruby</a></li><li class="subsection"><a href="static-pages#sec-layouts"><span class="number">3.3.4</span> Eliminating duplication with layouts</a></li></ol></li><li class="section"><a href="static-pages#sec-static_pages_conclusion"><span class="number">3.4</span> Conclusion</a></li><li class="section"><a href="static-pages#sec-static_pages_exercises"><span class="number">3.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="rails-flavored-ruby#top"><span class="number">Chapter 4</span> Rails-flavored Ruby</a></li><li><ol><li class="section"><a href="rails-flavored-ruby#sec-motivation"><span class="number">4.1</span> Motivation</a></li><li><ol><li class="subsection"><a href="rails-flavored-ruby#sec-title_helper"><span class="number">4.1.1</span> A <code>title</code> helper</a></li><li class="subsection"><a href="rails-flavored-ruby#sec-cascading_style_sheets"><span class="number">4.1.2</span> Cascading Style Sheets</a></li></ol></li><li class="section"><a href="rails-flavored-ruby#sec-strings_and_methods"><span class="number">4.2</span> Strings and methods</a></li><li><ol><li class="subsection"><a href="rails-flavored-ruby#sec-comments"><span class="number">4.2.1</span> Comments</a></li><li class="subsection"><a href="rails-flavored-ruby#sec-strings"><span class="number">4.2.2</span> Strings</a></li><li><ol><li class="subsubsection"><a href="rails-flavored-ruby#sec-printing">Printing</a></li><li class="subsubsection"><a href="rails-flavored-ruby#sec-single_quoted_strings">Single-quoted strings</a></li></ol></li><li class="subsection"><a href="rails-flavored-ruby#sec-objects_and_message_passing"><span class="number">4.2.3</span> Objects and message passing</a></li><li class="subsection"><a href="rails-flavored-ruby#sec-method_definitions"><span class="number">4.2.4</span> Method definitions</a></li><li class="subsection"><a href="rails-flavored-ruby#sec-back_to_the_title_helper"><span class="number">4.2.5</span> Back to the <code>title</code> helper</a></li></ol></li><li class="section"><a href="rails-flavored-ruby#sec-other_data_structures"><span class="number">4.3</span> Other data structures</a></li><li><ol><li class="subsection"><a href="rails-flavored-ruby#sec-arrays_and_ranges"><span class="number">4.3.1</span> Arrays and ranges</a></li><li class="subsection"><a href="rails-flavored-ruby#sec-blocks"><span class="number">4.3.2</span> Blocks</a></li><li class="subsection"><a href="rails-flavored-ruby#sec-hashes_and_symbols"><span class="number">4.3.3</span> Hashes and symbols</a></li><li class="subsection"><a href="rails-flavored-ruby#sec-css_revisited"><span class="number">4.3.4</span> CSS revisited</a></li></ol></li><li class="section"><a href="rails-flavored-ruby#sec-ruby_classes"><span class="number">4.4</span> Ruby classes</a></li><li><ol><li class="subsection"><a href="rails-flavored-ruby#sec-constructors"><span class="number">4.4.1</span> Constructors</a></li><li class="subsection"><a href="rails-flavored-ruby#sec-a_class_of_our_own"><span class="number">4.4.2</span> Class inheritance</a></li><li class="subsection"><a href="rails-flavored-ruby#sec-modifying_built_in_classes"><span class="number">4.4.3</span> Modifying built-in classes</a></li><li class="subsection"><a href="rails-flavored-ruby#sec-a_controller_class"><span class="number">4.4.4</span> A controller class</a></li><li class="subsection"><a href="rails-flavored-ruby#sec-a_user_class"><span class="number">4.4.5</span> A user class</a></li></ol></li><li class="section"><a href="rails-flavored-ruby#sec-exercises"><span class="number">4.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="filling-in-the-layout#top"><span class="number">Chapter 5</span> Filling in the layout</a></li><li><ol><li class="section"><a href="filling-in-the-layout#sec-structure"><span class="number">5.1</span> Adding some structure</a></li><li><ol><li class="subsection"><a href="filling-in-the-layout#sec-adding_to_the_layout"><span class="number">5.1.1</span> Site navigation</a></li><li class="subsection"><a href="filling-in-the-layout#sec-custom_css"><span class="number">5.1.2</span> Custom CSS</a></li><li class="subsection"><a href="filling-in-the-layout#sec-partials"><span class="number">5.1.3</span> Partials</a></li></ol></li><li class="section"><a href="filling-in-the-layout#sec-layout_links"><span class="number">5.2</span> Layout links</a></li><li><ol><li class="subsection"><a href="filling-in-the-layout#sec-integration_tests"><span class="number">5.2.1</span> Integration tests</a></li><li class="subsection"><a href="filling-in-the-layout#sec-rails_routes"><span class="number">5.2.2</span> Rails routes</a></li><li class="subsection"><a href="filling-in-the-layout#sec-named_routes"><span class="number">5.2.3</span> Named routes</a></li></ol></li><li class="section"><a href="filling-in-the-layout#sec-user_signup"><span class="number">5.3</span> User signup: A first step</a></li><li><ol><li class="subsection"><a href="filling-in-the-layout#sec-users_controller"><span class="number">5.3.1</span> Users controller</a></li><li class="subsection"><a href="filling-in-the-layout#sec-signup_url"><span class="number">5.3.2</span> Signup URL</a></li></ol></li><li class="section"><a href="filling-in-the-layout#sec-layout_conclusion"><span class="number">5.4</span> Conclusion</a></li><li class="section"><a href="filling-in-the-layout#sec-layout_exercises"><span class="number">5.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="modeling-and-viewing-users-one#top"><span class="number">Chapter 6</span> Modeling and viewing users, part I</a></li><li><ol><li class="section"><a href="modeling-and-viewing-users-one#sec-user_model"><span class="number">6.1</span> User model</a></li><li><ol><li class="subsection"><a href="modeling-and-viewing-users-one#sec-database_migrations"><span class="number">6.1.1</span> Database migrations</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec-the_model_file"><span class="number">6.1.2</span> The model file</a></li><li><ol><li class="subsubsection"><a href="modeling-and-viewing-users-one#sec-model_annotation">Model annotation</a></li><li class="subsubsection"><a href="modeling-and-viewing-users-one#sec-accessible_attributes">Accessible attributes</a></li></ol></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec-creating_user_objects"><span class="number">6.1.3</span> Creating user objects</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec-finding_user_objects"><span class="number">6.1.4</span> Finding user objects</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec-updating_user_objects"><span class="number">6.1.5</span> Updating user objects</a></li></ol></li><li class="section"><a href="modeling-and-viewing-users-one#sec-user_validations"><span class="number">6.2</span> User validations</a></li><li><ol><li class="subsection"><a href="modeling-and-viewing-users-one#sec-presence_validation"><span class="number">6.2.1</span> Validating presence</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec-length_validation"><span class="number">6.2.2</span> Length validation</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec-format_validation"><span class="number">6.2.3</span> Format validation</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec-uniqueness_validation"><span class="number">6.2.4</span> Uniqueness validation</a></li><li><ol><li class="subsubsection"><a href="modeling-and-viewing-users-one#sec-the_caveat">The uniqueness caveat</a></li></ol></li></ol></li><li class="section"><a href="modeling-and-viewing-users-one#sec-viewing_users"><span class="number">6.3</span> Viewing users</a></li><li><ol><li class="subsection"><a href="modeling-and-viewing-users-one#sec-rails_environments"><span class="number">6.3.1</span> Debug and Rails environments</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec-users_show"><span class="number">6.3.2</span> User model, view, controller</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec-a_users_resource"><span class="number">6.3.3</span> A Users resource</a></li><li><ol><li class="subsubsection"><a href="modeling-and-viewing-users-one#sec-params_in_debug"><code>params</code> in <code>debug</code></a></li></ol></li></ol></li><li class="section"><a href="modeling-and-viewing-users-one#sec-6_4"><span class="number">6.4</span> Conclusion</a></li><li class="section"><a href="modeling-and-viewing-users-one#sec-6_5"><span class="number">6.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="modeling-and-viewing-users-two#top"><span class="number">Chapter 7</span> Modeling and viewing users, part II</a></li><li><ol><li class="section"><a href="modeling-and-viewing-users-two#sec-insecure_passwords"><span class="number">7.1</span> Insecure passwords</a></li><li><ol><li class="subsection"><a href="modeling-and-viewing-users-two#sec-password_validations"><span class="number">7.1.1</span> Password validations</a></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec-password_migration"><span class="number">7.1.2</span> A password migration</a></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec-an_active_record_callback"><span class="number">7.1.3</span> An Active Record callback</a></li></ol></li><li class="section"><a href="modeling-and-viewing-users-two#sec-secure_passwords"><span class="number">7.2</span> Secure passwords</a></li><li><ol><li class="subsection"><a href="modeling-and-viewing-users-two#sec-a_secure_password_test"><span class="number">7.2.1</span> A secure password test</a></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec-secure_password_theory"><span class="number">7.2.2</span> Some secure password theory</a></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec-implementing_has_password"><span class="number">7.2.3</span> Implementing <code>has_password?</code></a></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec-an_authenticate_method"><span class="number">7.2.4</span> An authenticate method</a></li></ol></li><li class="section"><a href="modeling-and-viewing-users-two#sec-better_user_views"><span class="number">7.3</span> Better user views</a></li><li><ol><li class="subsection"><a href="modeling-and-viewing-users-two#sec-tests_with_factories"><span class="number">7.3.1</span> Testing the user show page (with factories)</a></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec-a_name_and_a_gravatar"><span class="number">7.3.2</span> A name and a Gravatar</a></li><li><ol><li class="subsubsection"><a href="modeling-and-viewing-users-two#sec-a_gravatar_helper">A Gravatar helper</a></li></ol></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec-a_user_sidebar"><span class="number">7.3.3</span> A user sidebar</a></li></ol></li><li class="section"><a href="modeling-and-viewing-users-two#sec-7_4"><span class="number">7.4</span> Conclusion</a></li><li><ol><li class="subsection"><a href="modeling-and-viewing-users-two#sec-7_4_1"><span class="number">7.4.1</span> Git commit</a></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec-heroku_deploy"><span class="number">7.4.2</span> Heroku deploy</a></li></ol></li><li class="section"><a href="modeling-and-viewing-users-two#sec-more_modeling_users_exercises"><span class="number">7.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="sign-up#top"><span class="number">Chapter 8</span> Sign up</a></li><li><ol><li class="section"><a href="sign-up#sec-signup_form"><span class="number">8.1</span> Signup form</a></li><li><ol><li class="subsection"><a href="sign-up#sec-using_form_for"><span class="number">8.1.1</span> Using <code>form_for</code></a></li><li class="subsection"><a href="sign-up#sec-the_form_html"><span class="number">8.1.2</span> The form HTML</a></li></ol></li><li class="section"><a href="sign-up#sec-signup_failure"><span class="number">8.2</span> Signup failure</a></li><li><ol><li class="subsection"><a href="sign-up#sec-testing_failure"><span class="number">8.2.1</span> Testing failure</a></li><li class="subsection"><a href="sign-up#sec-a_working_form"><span class="number">8.2.2</span> A working form</a></li><li class="subsection"><a href="sign-up#sec-signup_error_messages"><span class="number">8.2.3</span> Signup error messages</a></li><li class="subsection"><a href="sign-up#sec-filtering_parameter_logging"><span class="number">8.2.4</span> Filtering parameter logging</a></li></ol></li><li class="section"><a href="sign-up#sec-signup_success"><span class="number">8.3</span> Signup success</a></li><li><ol><li class="subsection"><a href="sign-up#sec-testing_success"><span class="number">8.3.1</span> Testing success</a></li><li class="subsection"><a href="sign-up#sec-the_finished_signup_form"><span class="number">8.3.2</span> The finished signup form</a></li><li class="subsection"><a href="sign-up#sec-the_flash"><span class="number">8.3.3</span> The flash</a></li><li class="subsection"><a href="sign-up#sec-the_first_signup"><span class="number">8.3.4</span> The first signup</a></li></ol></li><li class="section"><a href="sign-up#sec-rspec_integration_tests"><span class="number">8.4</span> RSpec integration tests</a></li><li><ol><li class="subsection"><a href="sign-up#sec-integration_tests_with_style"><span class="number">8.4.1</span> Integration tests with style</a></li><li class="subsection"><a href="sign-up#sec-failed_signup"><span class="number">8.4.2</span> Users signup failure should not make a new user</a></li><li class="subsection"><a href="sign-up#sec-successful_signup"><span class="number">8.4.3</span> Users signup success should make a new user</a></li></ol></li><li class="section"><a href="sign-up#sec-8_5"><span class="number">8.5</span> Conclusion</a></li><li class="section"><a href="sign-up#sec-signup_exercises"><span class="number">8.6</span> Exercises</a></li></ol></li><li class="chapter"><a href="sign-in-sign-out#top"><span class="number">Chapter 9</span> Sign in, sign out</a></li><li><ol><li class="section"><a href="sign-in-sign-out#sec-sessions"><span class="number">9.1</span> Sessions</a></li><li><ol><li class="subsection"><a href="sign-in-sign-out#sec-sessions_controller"><span class="number">9.1.1</span> Sessions controller</a></li><li class="subsection"><a href="sign-in-sign-out#sec-signin_form"><span class="number">9.1.2</span> Signin form</a></li></ol></li><li class="section"><a href="sign-in-sign-out#sec-signin_failure"><span class="number">9.2</span> Signin failure</a></li><li><ol><li class="subsection"><a href="sign-in-sign-out#sec-reviewing_form_submission"><span class="number">9.2.1</span> Reviewing form submission</a></li><li class="subsection"><a href="sign-in-sign-out#sec-failed_signin"><span class="number">9.2.2</span> Failed signin (test and code)</a></li></ol></li><li class="section"><a href="sign-in-sign-out#sec-signin_success"><span class="number">9.3</span> Signin success</a></li><li><ol><li class="subsection"><a href="sign-in-sign-out#sec-the_completed_create_action"><span class="number">9.3.1</span> The completed <code>create</code> action</a></li><li class="subsection"><a href="sign-in-sign-out#sec-remember_me"><span class="number">9.3.2</span> Remember me</a></li><li class="subsection"><a href="sign-in-sign-out#sec-current_user"><span class="number">9.3.3</span> Current user</a></li></ol></li><li class="section"><a href="sign-in-sign-out#sec-signing_out"><span class="number">9.4</span> Signing out</a></li><li><ol><li class="subsection"><a href="sign-in-sign-out#sec-destroying_sessions"><span class="number">9.4.1</span> Destroying sessions</a></li><li class="subsection"><a href="sign-in-sign-out#sec-signin_upon_signup"><span class="number">9.4.2</span> Signin upon signup</a></li><li class="subsection"><a href="sign-in-sign-out#sec-changing_the_layout_links"><span class="number">9.4.3</span> Changing the layout links</a></li><li class="subsection"><a href="sign-in-sign-out#sec-signin_out_integration_tests"><span class="number">9.4.4</span> Signin/out integration tests</a></li></ol></li><li class="section"><a href="sign-in-sign-out#sec-9_5"><span class="number">9.5</span> Conclusion</a></li><li class="section"><a href="sign-in-sign-out#sec-sign_in_out_exercises"><span class="number">9.6</span> Exercises</a></li></ol></li><li class="chapter"><a href="updating-showing-and-deleting-users#top"><span class="number">Chapter 10</span> Updating, showing, and deleting users</a></li><li><ol><li class="section"><a href="updating-showing-and-deleting-users#sec-updating_users"><span class="number">10.1</span> Updating users</a></li><li><ol><li class="subsection"><a href="updating-showing-and-deleting-users#sec-edit_form"><span class="number">10.1.1</span> Edit form</a></li><li class="subsection"><a href="updating-showing-and-deleting-users#sec-enabling_edits"><span class="number">10.1.2</span> Enabling edits</a></li></ol></li><li class="section"><a href="updating-showing-and-deleting-users#sec-protecting_pages"><span class="number">10.2</span> Protecting pages</a></li><li><ol><li class="subsection"><a href="updating-showing-and-deleting-users#sec-requiring_signed_in_users"><span class="number">10.2.1</span> Requiring signed-in users</a></li><li class="subsection"><a href="updating-showing-and-deleting-users#sec-requiring_the_right_user"><span class="number">10.2.2</span> Requiring the right user</a></li><li class="subsection"><a href="updating-showing-and-deleting-users#sec-friendly_forwarding"><span class="number">10.2.3</span> Friendly forwarding</a></li></ol></li><li class="section"><a href="updating-showing-and-deleting-users#sec-showing_users"><span class="number">10.3</span> Showing users</a></li><li><ol><li class="subsection"><a href="updating-showing-and-deleting-users#sec-user_index"><span class="number">10.3.1</span> User index</a></li><li class="subsection"><a href="updating-showing-and-deleting-users#sec-sample_users"><span class="number">10.3.2</span> Sample users</a></li><li class="subsection"><a href="updating-showing-and-deleting-users#sec-pagination"><span class="number">10.3.3</span> Pagination</a></li><li><ol><li class="subsubsection"><a href="updating-showing-and-deleting-users#sec-testing_pagination">Testing pagination</a></li></ol></li><li class="subsection"><a href="updating-showing-and-deleting-users#sec-partial_refactoring"><span class="number">10.3.4</span> Partial refactoring</a></li></ol></li><li class="section"><a href="updating-showing-and-deleting-users#sec-destroying_users"><span class="number">10.4</span> Destroying users</a></li><li><ol><li class="subsection"><a href="updating-showing-and-deleting-users#sec-administrative_users"><span class="number">10.4.1</span> Administrative users</a></li><li><ol><li class="subsubsection"><a href="updating-showing-and-deleting-users#sec-revisiting_attr_accessible">Revisiting <code>attr_accessible</code></a></li></ol></li><li class="subsection"><a href="updating-showing-and-deleting-users#sec-the_destroy_action"><span class="number">10.4.2</span> The <code>destroy</code> action</a></li></ol></li><li class="section"><a href="updating-showing-and-deleting-users#sec-10_5"><span class="number">10.5</span> Conclusion</a></li><li class="section"><a href="updating-showing-and-deleting-users#sec-updating_deleting_exercises"><span class="number">10.6</span> Exercises</a></li></ol></li><li class="chapter"><a href="user-microposts#top"><span class="number">Chapter 11</span> User microposts</a></li><li><ol><li class="section"><a href="user-microposts#sec-a_micropost_model"><span class="number">11.1</span> A Micropost model</a></li><li><ol><li class="subsection"><a href="user-microposts#sec-the_basic_model"><span class="number">11.1.1</span> The basic model</a></li><li><ol><li class="subsubsection"><a href="user-microposts#sec-accessible_attribute">Accessible attribute</a></li></ol></li><li class="subsection"><a href="user-microposts#sec-user_micropost_associations"><span class="number">11.1.2</span> User/Micropost associations</a></li><li class="subsection"><a href="user-microposts#sec-ordering_and_dependency"><span class="number">11.1.3</span> Micropost refinements</a></li><li><ol><li class="subsubsection"><a href="user-microposts#sec-default_scope">Default scope</a></li><li class="subsubsection"><a href="user-microposts#sec-dependent_destroy">Dependent: destroy</a></li></ol></li><li class="subsection"><a href="user-microposts#sec-micropost_validations"><span class="number">11.1.4</span> Micropost validations</a></li></ol></li><li class="section"><a href="user-microposts#sec-showing_microposts"><span class="number">11.2</span> Showing microposts</a></li><li><ol><li class="subsection"><a href="user-microposts#sec-augmenting_the_user_show_page"><span class="number">11.2.1</span> Augmenting the user show page</a></li><li class="subsection"><a href="user-microposts#sec-sample_microposts"><span class="number">11.2.2</span> Sample microposts</a></li></ol></li><li class="section"><a href="user-microposts#sec-manipulating_microposts"><span class="number">11.3</span> Manipulating microposts</a></li><li><ol><li class="subsection"><a href="user-microposts#sec-access_control"><span class="number">11.3.1</span> Access control</a></li><li class="subsection"><a href="user-microposts#sec-creating_microposts"><span class="number">11.3.2</span> Creating microposts</a></li><li class="subsection"><a href="user-microposts#sec-a_proto_feed"><span class="number">11.3.3</span> A proto-feed</a></li><li class="subsection"><a href="user-microposts#sec-destroying_microposts"><span class="number">11.3.4</span> Destroying microposts</a></li><li class="subsection"><a href="user-microposts#sec-testing_the_new_home_page"><span class="number">11.3.5</span> Testing the new home page</a></li></ol></li><li class="section"><a href="user-microposts#sec-11_4"><span class="number">11.4</span> Conclusion</a></li><li class="section"><a href="user-microposts#sec-micropost_exercises"><span class="number">11.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="following-users#top"><span class="number">Chapter 12</span> Following users</a></li><li><ol><li class="section"><a href="following-users#sec-the_relationship_model"><span class="number">12.1</span> The Relationship model</a></li><li><ol><li class="subsection"><a href="following-users#sec-a_problem_with_the_data_model"><span class="number">12.1.1</span> A problem with the data model (and a solution)</a></li><li class="subsection"><a href="following-users#sec-relationship_user_associations"><span class="number">12.1.2</span> User/relationship associations</a></li><li class="subsection"><a href="following-users#sec-relationship_validations"><span class="number">12.1.3</span> Validations</a></li><li class="subsection"><a href="following-users#sec-following"><span class="number">12.1.4</span> Following</a></li><li class="subsection"><a href="following-users#sec-followers"><span class="number">12.1.5</span> Followers</a></li></ol></li><li class="section"><a href="following-users#sec-a_web_interface_for_following_and_followers"><span class="number">12.2</span> A web interface for following and followers</a></li><li><ol><li class="subsection"><a href="following-users#sec-sample_following_data"><span class="number">12.2.1</span> Sample following data</a></li><li class="subsection"><a href="following-users#sec-stats_and_a_follow_form"><span class="number">12.2.2</span> Stats and a follow form</a></li><li class="subsection"><a href="following-users#sec-following_and_followers_pages"><span class="number">12.2.3</span> Following and followers pages</a></li><li class="subsection"><a href="following-users#sec-a_working_follow_button_the_standard_way"><span class="number">12.2.4</span> A working follow button the standard way</a></li><li class="subsection"><a href="following-users#sec-a_working_follow_button_with_ajax"><span class="number">12.2.5</span> A working follow button with Ajax</a></li></ol></li><li class="section"><a href="following-users#sec-the_status_feed"><span class="number">12.3</span> The status feed</a></li><li><ol><li class="subsection"><a href="following-users#sec-motivation_and_strategy"><span class="number">12.3.1</span> Motivation and strategy</a></li><li class="subsection"><a href="following-users#sec-a_first_feed_implementation"><span class="number">12.3.2</span> A first feed implementation</a></li><li class="subsection"><a href="following-users#sec-scopes_subselects_and_a_lambda"><span class="number">12.3.3</span> Scopes, subselects, and a lambda</a></li><li class="subsection"><a href="following-users#sec-the_new_status_feed"><span class="number">12.3.4</span> The new status feed</a></li></ol></li><li class="section"><a href="following-users#sec-following_conclusion"><span class="number">12.4</span> Conclusion</a></li><li><ol><li class="subsection"><a href="following-users#sec-extensions_to_the_sample_application"><span class="number">12.4.1</span> Extensions to the sample application</a></li><li><ol><li class="subsubsection"><a href="following-users#sec-replies">Replies</a></li><li class="subsubsection"><a href="following-users#sec-messaging">Messaging</a></li><li class="subsubsection"><a href="following-users#sec-follower_notifications">Follower notifications</a></li><li class="subsubsection"><a href="following-users#sec-password_reminders">Password reminders</a></li><li class="subsubsection"><a href="following-users#sec-signup_confirmation">Signup confirmation</a></li><li class="subsubsection"><a href="following-users#sec-rss_feed">RSS feed</a></li><li class="subsubsection"><a href="following-users#sec-rest_api">REST API</a></li><li class="subsubsection"><a href="following-users#sec-search">Search</a></li></ol></li><li class="subsection"><a href="following-users#sec-guide_to_further_resources"><span class="number">12.4.2</span> Guide to further resources</a></li></ol></li><li class="section"><a href="following-users#sec-following_exercises"><span class="number">12.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="rails-3-1#top"><span class="number">Chapter 13</span> Rails 3.1</a></li><li><ol><li class="section"><a href="rails-3-1#sec-upgrading_the_sample_app"><span class="number">13.1</span> Upgrading the sample app</a></li><li><ol><li class="subsection"><a href="rails-3-1#sec-installing_and_configuring_rails_3_1"><span class="number">13.1.1</span> Installing and configuring Rails&nbsp;3.1</a></li><li class="subsection"><a href="rails-3-1#sec-getting_to_red"><span class="number">13.1.2</span> Getting to Red</a></li><li class="subsection"><a href="rails-3-1#sec-minor_issues"><span class="number">13.1.3</span> Minor issues</a></li><li><ol><li class="subsubsection"><a href="rails-3-1#sec-will_paginate">will_paginate</a></li><li class="subsubsection"><a href="rails-3-1#sec-pagination_spec">Pagination spec</a></li></ol></li><li class="subsection"><a href="rails-3-1#sec-major_differences"><span class="number">13.1.4</span> Major differences</a></li><li><ol><li class="subsubsection"><a href="rails-3-1#sec-asset_directories">Asset directories</a></li><li class="subsubsection"><a href="rails-3-1#sec-prototype_to_jquery">Prototype to jQuery</a></li></ol></li></ol></li><li class="section"><a href="rails-3-1#sec-new_features"><span class="number">13.2</span> New features in Rails 3.1</a></li><li><ol><li class="subsection"><a href="rails-3-1#sec-asset_pipeline"><span class="number">13.2.1</span> Asset pipeline</a></li><li class="subsection"><a href="rails-3-1#sec-reversible_migrations"><span class="number">13.2.2</span> Reversible migrations</a></li><li class="subsection"><a href="rails-3-1#sec-sass_and_coffeescript"><span class="number">13.2.3</span> Sass and CoffeeScript</a></li></ol></li><li class="section"><a href="rails-3-1#sec-rails_3_1_exercises"><span class="number">13.3</span> Exercises</a></li></ol></li></ol></div>


<div id="main_content"></div>


<p> <span class="preamble">
 <span id="foreword">
<strong> Foreword</strong> <br />
 </span>
 </span></p>

<p>My former company (CD Baby) was one of the first to loudly switch to Ruby on Rails, and then even more loudly switch back to PHP (Google me to read about the drama). This book by Michael Hartl came so highly recommended that I had to try it, and <em>Ruby on Rails Tutorial</em> is what I used to switch back to Rails again.</p>

<p>Though I&rsquo;ve worked my way through many Rails books, this is the one that finally made me &ldquo;get&rdquo; it. Everything is done very much &ldquo;the Rails way&rdquo;&mdash;a way that felt very unnatural to me before, but now after doing this book finally feels natural. This is also the only Rails book that does test-driven development the entire time, an approach highly recommended by the experts but which has never been so clearly demonstrated before. Finally, by including Git, GitHub, and Heroku in the demo examples, the author really gives you a feel for what it&rsquo;s like to do a real-world project. The tutorial&rsquo;s code examples are not in isolation.</p>

<p>The linear narrative is such a great format. Personally, I powered through <em>Rails Tutorial</em> in three long days, doing all the examples and challenges at the end of each chapter. Do it from start to finish, without jumping around, and you&rsquo;ll get the ultimate benefit.</p>

<p>Enjoy!</p>

<p><a href="http://sivers.org/">Derek Sivers</a> (<a href="http://sivers.org/">sivers.org</a>) <br />
<em>Formerly: Founder,</em> <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> <br />
<em>Currently: Founder,</em> <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> <br /></p>

<p> <span class="preamble">
<strong> Acknowledgments</strong> <br />
 </span></p>

<p><em>Ruby on Rails Tutorial</em> owes a lot to my previous Rails book, <em>RailsSpace</em>, and hence to my coauthor <a href="http://aure.com/">Aurelius Prochazka</a>. I&rsquo;d like to thank Aure both for the work he did on that book and for his support of this one. I&rsquo;d also like to thank Debra Williams Cauley, my editor on both <em>RailsSpace</em> and <em>Rails Tutorial</em>; as long as she keeps taking me to baseball games, I&rsquo;ll keep writing books for her.</p>

<p>I&rsquo;d like to acknowledge a long list of Rubyists who have taught and inspired me over the years: David Heinemeier Hansson, Yehuda Katz, Carl Lerche, Jeremy Kemper, Xavier Noria, Ryan Bates, Geoffrey Grosenbach, Peter Cooper, Matt Aimonetti, Gregg Pollack, Wayne&nbsp;E. Seguin, Amy Hoy, Dave Chelimsky, Pat Maddox, Tom Preston-Werner, Chris Wanstrath, Chad Fowler, Josh Susser, Obie Fernandez, Ian McFarland, Steven Bristol, Wolfram Arnold, Alex Chaffee, Giles Bowkett, Evan Dorn, Long Nguyen, James Lindenbaum, Adam Wiggins, Tikhon Bernstam, Ron Evans, Wyatt Greene, Miles Forrest, the good people at Pivotal Labs, the Heroku gang, the thoughtbot guys, and the GitHub crew. Finally, many, many readers&mdash;far too many to list&mdash;have contributed a huge number of bug reports and suggestions during the writing of this book, and I gratefully acknowledge their help in making it as good as it can&nbsp;be. <br /></p>

<p> <span class="preamble">
 <span id="author">
<strong> About the author</strong> <br />
 </span>
 </span></p>

<p><a href="http://michaelhartl.com/">Michael Hartl</a> is a programmer, educator, and entrepreneur. Michael was coauthor of <em>RailsSpace</em>, a best-selling Rails tutorial book published in 2007, and was cofounder and lead developer of <a href="http://insoshi.com/">Insoshi</a>, a popular social networking platform in Ruby on Rails. Previously, he taught theoretical and computational physics at the <a href="http://www.caltech.edu/">California Institute of Technology</a> (Caltech), where he received the Lifetime Achievement Award for Excellence in Teaching. Michael is a graduate of <a href="http://college.harvard.edu/">Harvard College</a>, has a <a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">Ph.D. in Physics</a> from <a href="http://www.caltech.edu/">Caltech</a>, and is an alumnus of the <a href="http://ycombinator.com/">Y&nbsp;Combinator</a> entrepreneur program. <br /></p>

<p> <span id="license" class="preamble">
<strong> Copyright and license</strong> <br />
 </span></p>

<p><em>Ruby on Rails Tutorial: Learn Rails by Example</em>. Copyright &copy; 2010 by Michael Hartl. All source code in <em>Ruby on Rails Tutorial</em> is available under the <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> and the <a href="http://en.wikipedia.org/wiki/Beerware">Beerware License</a>.</p>

<pre class="verbatim">   Copyright (c) 2010 Michael Hartl

   Permission is hereby granted, free of charge, to any person
   obtaining a copy of this software and associated documentation
   files (the &quot;Software&quot;), to deal in the Software without
   restriction, including without limitation the rights to use,
   copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the
   Software is furnished to do so, subject to the following
   conditions:

   The above copyright notice and this permission notice shall be
   included in all copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
   EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
   OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
   NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
   HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
   WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
   FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
   OTHER DEALINGS IN THE SOFTWARE.</pre>




<pre class="verbatim">/*
 * ------------------------------------------------------------
 * &quot;THE BEERWARE LICENSE&quot; (Revision 42):
 * Michael Hartl wrote this code. As long as you retain this 
 * notice, you can do whatever you want with this stuff. If we
 * meet someday, and you think this stuff is worth it, you can
 * buy me a beer in return.
 * ------------------------------------------------------------
 */</pre>




<div id="top"></div>


<h1 class="chapter"><a id="sec-6" href="modeling-and-viewing-users-one#top" class="heading"><span class="number">Chapter 6</span> Modeling and viewing users, part I</a></h1>


<p>In <a class="ref" href="filling-in-the-layout#top">Chapter&nbsp;5</a>, we ended with a stub page for creating new users (<a class="ref" href="filling-in-the-layout#sec-user_signup">Section&nbsp;5.3</a>); over the course of the next three chapters, we&rsquo;ll fulfill the promise implicit in this incipient signup page. The first critical step is to create a <em>data model</em> for users of our site, together with a way to store that data. Completing this task is the goal for this chapter and the next (<a class="ref" href="modeling-and-viewing-users-two#top">Chapter&nbsp;7</a>), and we&rsquo;ll give users the ability to sign up in <a class="ref" href="sign-up#top">Chapter&nbsp;8</a>.  Once the sample application can create new users, we&rsquo;ll let them sign in and sign out (<a class="ref" href="sign-in-sign-out#top">Chapter&nbsp;9</a>), and in <a class="ref" href="updating-showing-and-deleting-users#top">Chapter&nbsp;10</a> we&rsquo;ll learn how to protect pages from improper access (<a class="ref" href="updating-showing-and-deleting-users#sec-protecting_pages">Section&nbsp;10.2</a>).</p>

<p>Taken together, the material in <a class="ref" href="modeling-and-viewing-users-one#top">Chapter&nbsp;6</a> through <a class="ref" href="updating-showing-and-deleting-users#top">Chapter&nbsp;10</a> develops a full Rails login and authentication system. As you may know, there are various pre-built authentication solutions out there in Rails land; <a class="ref" href="modeling-and-viewing-users-one#sidebar-roll_your_own">Box&nbsp;6.1</a> explains why (at least at first) it&rsquo;s a good idea to roll your own.</p>

<div class="label" id="sidebar-roll_your_own"></div>


<div class="sidebar"><span class="title"><span class="header">Box 6.1.</span><span class="description">Roll your own authentication system</span></span>
<p>Virtually all web applications nowadays require a login and authentication system of some sort. Unsurprisingly, most web frameworks have a plethora of options for implementing such systems, and Rails is no exception. Examples of authentication and authorization systems include <a href="http://github.com/thoughtbot/clearance">Clearance</a>, <a href="http://github.com/binarylogic/authlogic">Authlogic</a>, <a href="http://github.com/plataformatec/devise">Devise</a>, and <a href="http://railscasts.com/episodes/192-authorization-with-cancan">CanCan</a> (as well as non-Rails-specific solutions built on top of <a href="http://en.wikipedia.org/wiki/OpenID">OpenID</a> or <a href="http://en.wikipedia.org/wiki/Oauth">OAuth</a>). It&rsquo;s reasonable to ask why we should reinvent the wheel. Why not just use an off-the-shelf solution instead of rolling our own?</p>

<p>There are several reasons why building our own authentication system is a good idea. First, there is no standard answer to Rails authentication; tying the tutorial to a specific project would leave us open to the risk that our particular choice would go out of fashion or out of date. Moreover, even if we guessed right, the project&rsquo;s codebase would continue to evolve, rendering any tutorial explanation quickly obsolete. Finally, introducing all the authentication machinery at once would be a pedagogical disaster&mdash;to take one example, Clearance contains more than 1,000 lines of code and creates a complicated data model right from the start. Authentication systems are a challenging and rich programming exercise; rolling our own means that we can consider one small piece at a time, leading to a far deeper understanding&mdash;of both authentication and of Rails.</p>

<p>I encourage you to study <a class="ref" href="modeling-and-viewing-users-one#top">Chapter&nbsp;6</a> through <a class="ref" href="updating-showing-and-deleting-users#top">Chapter&nbsp;10</a> to give yourself a good foundation for future projects. When the time comes, if you decide to use an off-the-shelf authentication system for your own applications, you will be in a good position both to understand it and to tailor it to meet your specific needs.</p>
</div>


<p>In parallel with our data modeling, we&rsquo;ll also develop a web page for <em>showing</em> users, which will serve as the first step toward implementing the REST architecture for users (discussed briefly in <a class="ref" href="a-demo-app#sec-mvc_in_action">Section&nbsp;2.2.2</a>). Though we won&rsquo;t get very far in this chapter, our eventual goal for the user profile pages is to show the user&rsquo;s profile image, basic user data, and a list of microposts, as mocked up in <a class="ref" href="modeling-and-viewing-users-one#fig-profile_mockup">Figure&nbsp;6.1</a>.<sup class="footnote" id="fnref-6_1"><a href="#fn-6_1">1</a></sup> (<a class="ref" href="modeling-and-viewing-users-one#fig-profile_mockup">Figure&nbsp;6.1</a> has our first example of <em>lorem ipsum</em> text, which has a <a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">fascinating story</a> that you should definitely read about some time.) In this chapter, we&rsquo;ll lay the essential foundation for the user show page, and we&rsquo;ll start filling in the details starting in <a class="ref" href="modeling-and-viewing-users-two#top">Chapter&nbsp;7</a>.</p>

<div class="label" id="fig-profile_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_mockup.png" alt="profile_mockup" /></span></div><div class="caption"><span class="header">Figure 6.1: </span><span class="description">A mockup of our best guess at the user show page.&nbsp;<a href="http://railstutorial.org/images/figures/profile_mockup-full.png">(full size)</a></span></div></div>


<p>As usual, if you&rsquo;re following along using Git for version control, now would be a good time to make a topic branch for modeling users:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b modeling-users
</pre></div>
</div>


<p>(The first line here is just to make sure that you start on the master branch, so that the <tt>modeling-users</tt> topic branch is based on <tt>master</tt>. You can skip that command if you&rsquo;re already on the master branch.)</p>

<div class="label" id="sec-user_model"></div>


<h2><a id="sec-6_1" href="modeling-and-viewing-users-one#sec-user_model" class="heading"><span class="number">6.1</span> User model</a></h2>


<p>Although the ultimate goal of the next three chapters is to make a signup page for our site, it would do little good to accept signup information now, since we don&rsquo;t currently have any place to put it. Thus, the first step in signing up users is to make a data structure to capture and store their information. In Rails, the default data structure for a data model is called, naturally enough, a&nbsp;<em>model</em> (the M in MVC from <a class="ref" href="beginning#sec-mvc">Section&nbsp;1.2.6</a>). The default Rails solution to the problem of persistence is to use a <em>database</em> for long-term data storage, and the default library for interacting with the database is called <em>Active Record</em>.<sup class="footnote" id="fnref-6_2"><a href="#fn-6_2">2</a></sup></p>

<p>Active Record comes with a host of methods for creating, saving, and finding data objects, all without having to use the structured query language (SQL)<sup class="footnote" id="fnref-6_3"><a href="#fn-6_3">3</a></sup> used by <a href="http://en.wikipedia.org/wiki/Relational_database">relational databases</a>. Moreover, Rails has a feature called <em>migrations</em> to allow data definitions to be written in pure Ruby, without having to learn an SQL data definition language (DDL).<sup class="footnote" id="fnref-6_4"><a href="#fn-6_4">4</a></sup> The effect is that Rails insulates you almost entirely from the details of the data store. In this book, by using SQLite for development and Heroku for deployment (<a class="ref" href="beginning#sec-deploying">Section&nbsp;1.4</a>), we have developed this theme even further, to the point where we barely ever have to think about how Rails stores data, even for production applications.<sup class="footnote" id="fnref-6_5"><a href="#fn-6_5">5</a></sup></p>

<div class="label" id="sec-database_migrations"></div>


<h3><a id="sec-6_1_1" href="modeling-and-viewing-users-one#sec-database_migrations" class="heading"><span class="number">6.1.1</span> Database migrations</a></h3>


<p>You may recall from <a class="ref" href="rails-flavored-ruby#sec-a_user_class">Section&nbsp;4.4.5</a> that we have already encountered, via a custom-built <code>User</code> class, user objects with <code>name</code> and <code>email</code> attributes. That class served as a useful example, but it lacked the critical property of <em>persistence</em>: when we created a User object at the Rails console, it disappeared as soon as we exited. Our goal in this section is to create a model for users that won&rsquo;t disappear quite so easily.</p>

<p>As with the User class in <a class="ref" href="rails-flavored-ruby#sec-a_user_class">Section&nbsp;4.4.5</a>, we&rsquo;ll start by modeling a user with two attributes, a <code>name</code> and an <code>email</code> address, the latter of which we&rsquo;ll use as a unique username.<sup class="footnote" id="fnref-6_6"><a href="#fn-6_6">6</a></sup> (We&rsquo;ll add a password attribute in <a class="ref" href="modeling-and-viewing-users-two#sec-insecure_passwords">Section&nbsp;7.1</a>.) In <a class="ref" href="rails-flavored-ruby#code-example_user">Listing&nbsp;4.8</a>, we did this with Ruby&rsquo;s <code>attr_accessor</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>In contrast, when using Rails to model users we don&rsquo;t need to identify the attributes explicitly. As noted briefly above, to store data Rails uses a relational database by default, which consists of <em>tables</em> composed of data <em>rows</em>, where each row has <em>columns</em> of data attributes. For example, to store users with names and email addresses, we&rsquo;ll create a <code>users</code> table with <code>name</code> and <code>email</code> columns (with each row corresponding to one user). By naming the columns in this way, we&rsquo;ll let Active Record figure out the User object attributes for us.</p>

<p>Let&rsquo;s see how this works. (If this discussion gets too abstract for your taste, be patient; the console examples starting in <a class="ref" href="modeling-and-viewing-users-one#sec-creating_user_objects">Section&nbsp;6.1.3</a> and the database browser screenshots in <a class="ref" href="modeling-and-viewing-users-one#fig-sqlite_database_browser">Figure&nbsp;6.3</a> and <a class="ref" href="modeling-and-viewing-users-one#fig-sqlite_user_row">Figure&nbsp;6.8</a> should make things clearer.) In <a class="ref" href="filling-in-the-layout#sec-users_controller">Section&nbsp;5.3.1</a>, recall (<a class="ref" href="filling-in-the-layout#code-generate_users_controller">Listing&nbsp;5.23</a>) that we created a Users controller (along with a <code>new</code> action) using the command</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Users new
</pre></div>
</div>


<p>There is an analogous command for making a model: <code>generate model</code>; <a class="ref" href="modeling-and-viewing-users-one#code-generate_user_model">Listing&nbsp;6.1</a> shows the command to generate a User model with two attributes, <code>name</code> and <code>email</code>.</p>

<div class="label" id="code-generate_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.1.</span> <span class="description">Generating a User model.</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model User name:string email:string
<span class="go">      invoke  active_record</span>
<span class="go">      create    db/migrate/&lt;timestamp&gt;_create_users.rb</span>
<span class="go">      create    app/models/user.rb</span>
<span class="go">      invoke    rspec</span>
<span class="go">      create      spec/models/user_spec.rb</span>
</pre></div>
</div></div>


<p>(Note that, in contrast to the plural convention for controller names, model names are singular: a Users controller, but a User model.) By passing the optional parameters <code>name:string</code> and <code>email:string</code>, we tell Rails about the two attributes we want, along with what types those attributes should be (in this case, <code>string</code>). Compare this with including the action names in <a class="ref" href="static-pages#code-generating_pages">Listing&nbsp;3.4</a> and <a class="ref" href="filling-in-the-layout#code-generate_users_controller">Listing&nbsp;5.23</a>.</p>

<p>One of the results of the <code>generate</code> command in <a class="ref" href="modeling-and-viewing-users-one#code-generate_user_model">Listing&nbsp;6.1</a> is a new file called a <em>migration</em>.  Migrations provide a way to alter the structure of the database incrementally, so that our data model can adapt to changing requirements. In the case of the User model, the migration is created automatically by the model generation script; it creates a <code>users</code> table with two columns, <code>name</code> and <code>email</code>, as shown in <a class="ref" href="modeling-and-viewing-users-one#code-users_migration">Listing&nbsp;6.2</a>. (We&rsquo;ll see in <a class="ref" href="modeling-and-viewing-users-one#sec-uniqueness_validation">Section&nbsp;6.2.4</a> how to make a migration from scratch.)</p>

<div class="label" id="code-users_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.2.</span> <span class="description">Migration for the User model (to create a <code>users</code> table). <br /> <code>db/migrate/&lt;timestamp&gt;_create_users.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:email</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">drop_table</span> <span class="ss">:users</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that the name of the migration is prefixed by a <em>timestamp</em> based on when the migration was generated. In the early days of migrations, the filenames were prefixed with incrementing integers, which caused conflicts for collaborating teams if multiple programmers had migrations with the same number. Barring highly improbable millisecond-level simultaneity, using timestamps conveniently avoids such collisions.</p>

<p>Let&rsquo;s focus on the <code>self.up</code> method, which uses a Rails method called <code>create_table</code> to create a <em>table</em> in the database for storing users. (The use of <code>self</code> in <code>self.up</code> identifies it as a <em>class method</em>. This doesn&rsquo;t matter now, but we&rsquo;ll learn about class methods when we make one of our own in <a class="ref" href="modeling-and-viewing-users-two#sec-an_authenticate_method">Section&nbsp;7.2.4</a>.) The <code>create_table</code> method accepts a block (<a class="ref" href="rails-flavored-ruby#sec-blocks">Section&nbsp;4.3.2</a>) with one block variable, in this case called <code>t</code> (for &ldquo;table&rdquo;). Inside the block, the <code>create_table</code> method uses the <code>t</code>&nbsp;object to create <code>name</code> and <code>email</code> columns in the database, both of type <code>string</code>.<sup class="footnote" id="fnref-6_7"><a href="#fn-6_7">7</a></sup> Here the table name is plural (<code>users</code>) even though the model name is singular (User), which reflects a linguistic convention followed by Rails: a model represents a single user, whereas a database table consists of many users. The final line in the block, <code>t.timestamps</code>, is a special command that creates two <em>magic columns</em> called <code>created_at</code> and <code>updated_at</code>, which are timestamps that automatically record when a given user is created and updated. (We&rsquo;ll see concrete examples of the magic columns starting in <a class="ref" href="modeling-and-viewing-users-one#sec-creating_user_objects">Section&nbsp;6.1.3</a>.) The full data model represented by this migration is shown in <a class="ref" href="modeling-and-viewing-users-one#fig-user_model_initial">Figure&nbsp;6.2</a>.</p>

<div class="label" id="fig-user_model_initial"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_initial.png" alt="user_model_initial" /></span></div><div class="caption"><span class="header">Figure 6.2: </span><span class="description">The users data model produced by <a class="ref" href="modeling-and-viewing-users-one#code-users_migration">Listing&nbsp;6.2</a>.</span></div></div>


<p>We can run the migration, known as &ldquo;migrating up&rdquo;, using the <code>rake</code> command (<a class="ref" href="a-demo-app#sidebar-rake">Box&nbsp;2.1</a>) as follows:<sup class="footnote" id="fnref-6_8"><a href="#fn-6_8">8</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>


<p>(You may recall that we ran this command once before, in <a class="ref" href="a-demo-app#sec-demo_users_resource">Section&nbsp;2.2</a>.) The first time <code>db:migrate</code> is run, it creates a file called <code>db/development.sqlite3</code>, which is an <a href="http://sqlite.org/">SQLite</a><sup class="footnote" id="fnref-6_9"><a href="#fn-6_9">9</a></sup> database. We can see the structure of the database using the excellent <a href="http://sqlitebrowser.sourceforge.net/">SQLite Database Browser</a> to open the <code>db/development.sqlite3</code> file (<a class="ref" href="modeling-and-viewing-users-one#fig-sqlite_database_browser">Figure&nbsp;6.3</a>); compare with the diagram in <a class="ref" href="modeling-and-viewing-users-one#fig-user_model_initial">Figure&nbsp;6.2</a>.  You might note that there&rsquo;s one column in <a class="ref" href="modeling-and-viewing-users-one#fig-sqlite_database_browser">Figure&nbsp;6.3</a> not accounted for in the migration: the <code>id</code> column. As noted briefly in <a class="ref" href="a-demo-app#sec-demo_users_resource">Section&nbsp;2.2</a>, this column is created automatically, and is used by Rails to identify each row uniquely.</p>

<div class="label" id="fig-sqlite_database_browser"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sqlite_database_browser.png" alt="sqlite_database_browser" /></span></div><div class="caption"><span class="header">Figure 6.3: </span><span class="description">The  <a href="http://sqlitebrowser.sourceforge.net/">SQLite Database Browser</a> with our new <code>users</code> table.&nbsp;<a href="http://railstutorial.org/images/figures/sqlite_database_browser-full.png">(full size)</a></span></div></div>


<p>You&rsquo;ve probably inferred that running <code>db:migrate</code> executes the <code>self.up</code> command in the migration file. What, then, of <code>self.down</code>? As you might guess, <code>down</code> migrates <em>down</em>, reversing the effects of migrating up. In our case, this means <em>dropping</em> the <code>users</code> table from the database:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">drop_table</span> <span class="ss">:users</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>You can execute <code>down</code> with <code>rake</code> using the argument <code>db:rollback</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:rollback
</pre></div>
</div>


<p>This is often useful if you realize there&rsquo;s another column you want to add but don&rsquo;t want the trouble of making a new migration: you can roll back the migration, add the desired column, and then migrate back up. (This isn&rsquo;t always convenient, and we&rsquo;ll learn how to add columns to an existing table in <a class="ref" href="modeling-and-viewing-users-two#sec-password_migration">Section&nbsp;7.1.2</a>.)</p>

<p>If you rolled back the database, migrate up again before proceeding:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>




<div class="label" id="sec-the_model_file"></div>


<h3><a id="sec-6_1_2" href="modeling-and-viewing-users-one#sec-the_model_file" class="heading"><span class="number">6.1.2</span> The model file</a></h3>


<p>We&rsquo;ve seen how the User model generation in <a class="ref" href="modeling-and-viewing-users-one#code-generate_user_model">Listing&nbsp;6.1</a> generated a migration file (<a class="ref" href="modeling-and-viewing-users-one#code-users_migration">Listing&nbsp;6.2</a>), and we saw in <a class="ref" href="modeling-and-viewing-users-one#fig-sqlite_database_browser">Figure&nbsp;6.3</a> the results of running this migration: it updated a file called <code>development.sqlite3</code> by creating a table <code>users</code> with columns <code>id</code>, <code>name</code>, <code>email</code>, <code>created_at</code>, and <code>updated_at</code>. <a class="ref" href="modeling-and-viewing-users-one#code-generate_user_model">Listing&nbsp;6.1</a> also created the model itself; the rest of this section is dedicated to understanding it.</p>

<p>We begin by looking at the code for the User model, which lives in the file <code>user.rb</code> inside the <code>app/models/</code> directory; it is, to put it mildly, very compact (<a class="ref" href="modeling-and-viewing-users-one#code-raw_user_model">Listing&nbsp;6.3</a>).</p>

<div class="label" id="code-raw_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.3.</span> <span class="description">The brand new User model. <br /> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Recall from <a class="ref" href="rails-flavored-ruby#sec-a_class_of_our_own">Section&nbsp;4.4.2</a> that the syntax <code>class User &lt; ActiveRecord::Base</code> means that the <code>User</code> class <em>inherits</em> from <code>ActiveRecord::Base</code>, so that the User model automatically has all the functionality of the <code>ActiveRecord::Base</code> class. Of course, knowledge of this inheritance doesn&rsquo;t do any good unless we know what <code>ActiveRecord::Base</code> contains, and we&rsquo;ll get a first taste starting momentarily. Before we move on, though, there are two tasks to complete.</p>

<div class="label" id="sec-model_annotation"></div>


<h4><a id="sec-6_1_2_1" href="modeling-and-viewing-users-one#sec-model_annotation" class="heading">Model annotation</a></h4>


<p>Though it&rsquo;s not strictly necessary, you might find it convenient to <em>annotate</em> your Rails models using the <tt>annotate</tt> gem (<a class="ref" href="modeling-and-viewing-users-one#code-gemfile_annotate">Listing&nbsp;6.4</a>).</p>

<div class="label" id="code-gemfile_annotate"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.4.</span> <span class="description">Adding the <tt>annotate</tt> gem to the <code>Gemfile</code>.</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.6.1&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;annotate&#39;</span><span class="p">,</span> <span class="s1">&#39;2.4.0&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(We place the <tt>annotate</tt> gem in a <code>group :development</code> block (analogous to <code>group :test</code>) because the annotations aren&rsquo;t needed in production applications.) We next install it with <code>bundle</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>This gives us a command called <code>annotate</code>, which simply adds comments containing the data model to the model file:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>annotate --position before
<span class="go">Annotated (1): User</span>
</pre></div>
</div>


<p>The results appear in <a class="ref" href="modeling-and-viewing-users-one#code-annotated_user_model">Listing&nbsp;6.5</a>.</p>

<div class="label" id="code-annotated_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.5.</span> <span class="description">The annotated User model. <br /> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="c1"># == Schema Information</span>
<span class="c1">#</span>
<span class="c1"># Table name: users</span>
<span class="c1">#</span>
<span class="c1">#  id         :integer         not null, primary key</span>
<span class="c1">#  name       :string(255)</span>
<span class="c1">#  email      :string(255)</span>
<span class="c1">#  created_at :datetime</span>
<span class="c1">#  updated_at :datetime</span>
<span class="c1">#</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>I find that having the data model visible in the model files helps remind me which attributes the model has, but future code listings will usually omit the annotations for brevity.</p>

<div class="label" id="sec-accessible_attributes"></div>


<h4><a id="sec-6_1_2_2" href="modeling-and-viewing-users-one#sec-accessible_attributes" class="heading">Accessible attributes</a></h4>


<p>Another step that isn&rsquo;t strictly necessary but is a really good idea is to tell Rails which attributes of the model are accessible, i.e., which attributes can be modified by outside users (such as users submitting requests with web browsers). We do this with the <code>attr_accessible</code> method (<a class="ref" href="modeling-and-viewing-users-one#code-attr_accessible">Listing&nbsp;6.6</a>). We&rsquo;ll see in <a class="ref" href="updating-showing-and-deleting-users#top">Chapter&nbsp;10</a> that using <code>attr_accessible</code> is important for preventing a <em>mass assignment</em> vulnerability, a distressingly common and often serious security hole in many Rails applications.</p>

<div class="label" id="code-attr_accessible"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.6.</span> <span class="description">Making the <code>name</code> and <code>email</code> attributes accessible. <br /> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-creating_user_objects"></div>


<h3><a id="sec-6_1_3" href="modeling-and-viewing-users-one#sec-creating_user_objects" class="heading"><span class="number">6.1.3</span> Creating user objects</a></h3>


<p>We&rsquo;ve done some good prep work, and now it&rsquo;s time to cash in and learn about Active Record by playing with our newly created User model. As in <a class="ref" href="rails-flavored-ruby#top">Chapter&nbsp;4</a>, our tool of choice is the Rails console. Since we don&rsquo;t (yet) want to make any changes to our database, we&rsquo;ll start the console in a <em>sandbox</em>:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="go">Loading development environment in sandbox (Rails 3.0.12)</span>
<span class="go">Any modifications you make will be rolled back on exit</span>
<span class="gp">&gt;&gt; </span>
</pre></div>
</div>


<p>As indicated by the helpful message &ldquo;Any modifications you make will be rolled back on exit&rdquo;, when started in a sandbox the console will &ldquo;roll back&rdquo; (i.e., undo) any database changes introduced during the session.</p>

<p>When working at the console, it&rsquo;s useful to keep an eye on the <em>development log</em>, which records the actual low-level SQL statements being issued by Active Record, as shown in <a class="ref" href="modeling-and-viewing-users-one#fig-development_log">Figure&nbsp;6.4</a>. The way to get this output at a Unix command line is to <code>tail</code> the log:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> tail -f log/development.log
</pre></div>
</div>


<p>The <code>-f</code> flag ensures that <code>tail</code> will display additional lines as they are written. I recommend keeping an open terminal window for tailing the log whenever working at the console.</p>

<div class="label" id="fig-development_log"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/development_log.png" alt="development_log" /></span></div><div class="caption"><span class="header">Figure 6.4: </span><span class="description">Tailing the development log.&nbsp;<a href="http://railstutorial.org/images/figures/development_log-full.png">(full size)</a></span></div></div>


<p>In the console session in <a class="ref" href="rails-flavored-ruby#sec-a_user_class">Section&nbsp;4.4.5</a>, we created a new user object with <code>User.new</code>, which we had access to only after requiring the example user file in <a class="ref" href="rails-flavored-ruby#code-example_user">Listing&nbsp;4.8</a>. With models, the situation is different; as you may recall from <a class="ref" href="rails-flavored-ruby#sec-a_controller_class">Section&nbsp;4.4.4</a>, the Rails console automatically loads the Rails environment, which includes the models. This means that we can make a new user object without any further work:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;User id: nil, name: nil, email: nil, created_at: nil, updated_at: nil&gt;</span>
</pre></div>
</div>


<p>We see here the default console representation of a user object, which prints out the same attributes shown in <a class="ref" href="modeling-and-viewing-users-one#fig-sqlite_database_browser">Figure&nbsp;6.3</a> and <a class="ref" href="modeling-and-viewing-users-one#code-annotated_user_model">Listing&nbsp;6.5</a>.</p>

<p>When called with no arguments, <code>User.new</code> returns an object with all <code>nil</code> attributes. In <a class="ref" href="rails-flavored-ruby#sec-a_user_class">Section&nbsp;4.4.5</a>, we designed the example User class to take an <em>initialization hash</em> to set the object attributes; that design choice was motivated by Active Record, which allows objects to be initialized in the same way:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: nil, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: nil, updated_at: nil&gt;</span>
</pre></div>
</div>


<p>Here we see that the name and email attributes have been set as expected.</p>

<p>If you&rsquo;ve been tailing the development log, you may have noticed that no new lines have shown up yet. This is because calling <code>User.new</code> doesn&rsquo;t touch the database; it simply creates a new Ruby object in memory. To save the user object to the database, we call the <code>save</code> method on the <code>user</code> variable:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>The <code>save</code> method returns <code>true</code> if it succeeds and <code>false</code> otherwise. (Currently, all saves should succeed; we&rsquo;ll see cases in <a class="ref" href="modeling-and-viewing-users-one#sec-user_validations">Section&nbsp;6.2</a> when some will fail.) As soon as you save, you should see a line in the development log with the SQL command to <code>INSERT INTO "users"</code>. Because of the many methods supplied by Active Record, we won&rsquo;t ever need raw SQL in this book, and I&rsquo;ll omit discussion of the SQL commands from now on. But you can learn a lot by watching the log.</p>

<p>You may have noticed that the new user object had <code>nil</code> values for the <code>id</code> and the magic columns <code>created_at</code> and <code>updated_at</code> attributes. Let&rsquo;s see if our <code>save</code> changed anything:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>We see that the <code>id</code> has been assigned a value of&nbsp;<code>1</code>, while the magic columns have been assigned the current time and date.<sup class="footnote" id="fnref-6_10"><a href="#fn-6_10">10</a></sup> Currently the created and updated timestamps are identical; we&rsquo;ll see them differ in <a class="ref" href="modeling-and-viewing-users-one#sec-updating_user_objects">Section&nbsp;6.1.5</a>.</p>

<p>As with the User class in <a class="ref" href="rails-flavored-ruby#sec-a_user_class">Section&nbsp;4.4.5</a>, instances of the User model allow access to their attributes using a dot notation:<sup class="footnote" id="fnref-6_11"><a href="#fn-6_11">11</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.com&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; Tue, 05 Jan 2010 00:57:46 UTC +00:00</span>
</pre></div>
</div>


<p>As we&rsquo;ll see in <a class="ref" href="sign-up#top">Chapter&nbsp;8</a>, it&rsquo;s often convenient to make and save a model in two steps as we have above, but Active Record also lets you combine them into one step with <code>User.create</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;A Nother&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;another@example.org&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 2, name: &quot;A Nother&quot;, email: &quot;another@example.org&quot;, created_at:</span>
<span class="go">&quot;2010-01-05 01:05:24&quot;, updated_at: &quot;2010-01-05 01:05:24&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">foo</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo@bar.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 3, name: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2010-01-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2010-01-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>Note that <code>User.create</code>, rather than returning <code>true</code> or <code>false</code>, returns the User object itself, which we can optionally assign to a variable (such as <code>foo</code> in the second command above).</p>

<p>The inverse of <code>create</code> is <code>destroy</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span><span class="o">.</span><span class="n">destroy</span>
<span class="go">=&gt; #&lt;User id: 3, name: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2010-01-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2010-01-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>Oddly, <code>destroy</code>, like <code>create</code>, returns the object in question, though I can&rsquo;t recall ever having used the return value of <code>destroy</code>. Even odder, perhaps, is that the <code>destroy</code>ed object still exists in memory:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span>
<span class="go">=&gt; #&lt;User id: 3, name: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2010-01-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2010-01-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>How do we know if we really destroyed an object? And for saved and non-destroyed objects, how can we retrieve users from the database? It&rsquo;s time to learn how to use Active Record to find user objects.</p>

<div class="label" id="sec-finding_user_objects"></div>


<h3><a id="sec-6_1_4" href="modeling-and-viewing-users-one#sec-finding_user_objects" class="heading"><span class="number">6.1.4</span> Finding user objects</a></h3>


<p>Active Record provides several options for finding objects. Let&rsquo;s use them to find the first user we created while verifying that the third user (<code>foo</code>) has been destroyed. We&rsquo;ll start with the existing user:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>Here we&rsquo;ve passed the id of the user to <code>User.find</code>; Active Record returns the user with that <code>id</code> attribute.</p>

<p>Let&rsquo;s see if the user with an <code>id</code> of&nbsp;<code>3</code> still exists in the database:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">ActiveRecord::RecordNotFound: Couldn&#39;t find User with ID=3</span>
</pre></div>
</div>


<p>Since we destroyed our third user in <a class="ref" href="modeling-and-viewing-users-one#sec-creating_user_objects">Section&nbsp;6.1.3</a>, Active Record can&rsquo;t find it in the database. Instead, <code>find</code> raises an <em>exception</em>, which is a way of indicating an exceptional event in the execution of a program&mdash;in this case, a nonexistent Active Record id, which causes <code>find</code> to raise an <code>ActiveRecord::RecordNotFound</code> exception.<sup class="footnote" id="fnref-6_12"><a href="#fn-6_12">12</a></sup></p>

<p>In addition to the generic <code>find</code>, Active Record also allows us to find users by specific attributes:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>Since we will be using email addresses as usernames, this sort of find will be useful when we learn how to let users sign in to our site (<a class="ref" href="sign-up#top">Chapter&nbsp;8</a>).<sup class="footnote" id="fnref-6_13"><a href="#fn-6_13">13</a></sup></p>

<p>We&rsquo;ll end with a couple of more general ways of finding users. First, there&rsquo;s <code>first</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>Naturally, <code>first</code> just returns the first user in the database. There&rsquo;s also <code>all</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span>
<span class="go">=&gt; [#&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;,</span>
<span class="go">#&lt;User id: 2, name: &quot;A Nother&quot;, email: &quot;another@example.org&quot;, created_at:</span>
<span class="go">&quot;2010-01-05 01:05:24&quot;, updated_at: &quot;2010-01-05 01:05:24&quot;&gt;]</span>
</pre></div>
</div>


<p>No prizes for inferring that <code>all</code> returns an array (<a class="ref" href="rails-flavored-ruby#sec-arrays_and_ranges">Section&nbsp;4.3.1</a>) of all users in the database.</p>

<div class="label" id="sec-updating_user_objects"></div>


<h3><a id="sec-6_1_5" href="modeling-and-viewing-users-one#sec-updating_user_objects" class="heading"><span class="number">6.1.5</span> Updating user objects</a></h3>


<p>Once we&rsquo;ve created objects, we often want to update them. There are two basic ways to do this. First, we can assign attributes individually, as we did in <a class="ref" href="rails-flavored-ruby#sec-a_user_class">Section&nbsp;4.4.5</a>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>           <span class="c1"># Just a reminder about our user&#39;s attributes</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;mhartl@example.net&quot;</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Note that the final step is necessary to write the changes to the database. We can see what happens without a save by using <code>reload</code>, which reloads the object based on the database information:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;foo@bar.com&quot;</span>
<span class="go">=&gt; &quot;foo@bar.com&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
</pre></div>
</div>


<p>Now that we&rsquo;ve updated the user, the magic columns differ, as promised in <a class="ref" href="modeling-and-viewing-users-one#sec-creating_user_objects">Section&nbsp;6.1.3</a>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span>
<span class="go">=&gt; &quot;2010-01-05 00:57:46&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; &quot;2010-01-05 01:37:32&quot;</span>
</pre></div>
</div>


<p>The second way to update attributes is to use <code>update_attributes</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;The Dude&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;dude@abides.org&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">=&gt; &quot;The Dude&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;dude@abides.org&quot;</span>
</pre></div>
</div>


<p>The <code>update_attributes</code> method accepts a hash of attributes, and on success performs both the update and the save in one step (returning <code>true</code> to indicate that the save went through). It&rsquo;s worth noting that, once you have defined some attributes as accessible using <code>attr_accessible</code> (<a class="ref" href="modeling-and-viewing-users-one#sec-accessible_attributes">Section&nbsp;6.1.2.2</a>), <em>only</em> those attributes can be modified using <code>update_attributes</code>. If you ever find that your models mysteriously start refusing to update certain columns, check to make sure that those columns are included in the call to <code>attr_accessible</code>.</p>

<div class="label" id="sec-user_validations"></div>


<h2><a id="sec-6_2" href="modeling-and-viewing-users-one#sec-user_validations" class="heading"><span class="number">6.2</span> User validations</a></h2>


<p>The User model we created in <a class="ref" href="modeling-and-viewing-users-one#sec-user_model">Section&nbsp;6.1</a> now has working <code>name</code> and <code>email</code> attributes, but they are completely generic: any string (including an empty one) is currently valid in either case. And yet, names and email addresses are more specific than this. For example, <code>name</code> should be non-blank, and <code>email</code> should match the specific format characteristic of email addresses. Moreover, since we&rsquo;ll be using email addresses as unique usernames when users sign in, we shouldn&rsquo;t allow email duplicates in the database.</p>

<p>In short, we shouldn&rsquo;t allow <code>name</code> and <code>email</code> to be just any strings; we should enforce certain constraints on their values. Active Record allows us to impose such constraints using <em>validations</em>. In this section, we&rsquo;ll cover several of the most common cases, validating <em>presence</em>, <em>length</em>, <em>format</em> and <em>uniqueness</em>. In <a class="ref" href="modeling-and-viewing-users-two#sec-password_validations">Section&nbsp;7.1.1</a> we&rsquo;ll add a final common validation, <em>confirmation</em>. And we&rsquo;ll see in <a class="ref" href="sign-up#sec-signup_failure">Section&nbsp;8.2</a> how validations give us convenient error messages when users make submissions that violate them.</p>

<p>As with the other features of our sample app, we&rsquo;ll add User model validations using test-driven development. Since we&rsquo;ve changed the data model, it&rsquo;s a good idea to prepare the test database before proceeding:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>This just ensures that the data model from the development database, <code>db/development.sqlite3</code>, is reflected in the test database, <code>db/test.sqlite3</code>.</p>

<div class="label" id="sec-presence_validation"></div>


<h3><a id="sec-6_2_1" href="modeling-and-viewing-users-one#sec-presence_validation" class="heading"><span class="number">6.2.1</span> Validating presence</a></h3>


<p>We&rsquo;ll start with a test for the presence of a <code>name</code> attribute. Although the first step in TDD is to write a <em>failing</em> test (<a class="ref" href="static-pages#sec-TDD">Section&nbsp;3.2.2</a>), in this case we don&rsquo;t yet know enough about validations to write the proper test, so we&rsquo;ll write the validation first, using the console to understand it. Then we&rsquo;ll comment out the validation, write a failing test, and verify that uncommenting the validation gets the test to pass. This procedure may seem pedantic for such a simple test, but I have seen<sup class="footnote" id="fnref-6_14"><a href="#fn-6_14">14</a></sup> <em>many</em> &ldquo;simple&rdquo; tests that test the wrong thing; being meticulous about TDD is simply the <em>only</em> way to be confident that we&rsquo;re testing the right thing. (This comment-out technique is also useful when rescuing an application whose application code is already written but&mdash;<a href="http://en.wiktionary.org/wiki/quelle_horreur"><em>quelle horreur!</em></a>&mdash;has no tests.)</p>

<p>The way to validate the presence of the name attribute is to use the <code>validates</code> method with argument <code>:presence =&gt; true</code>, as shown in  <a class="ref" href="modeling-and-viewing-users-one#code-validates_presence_of_name">Listing&nbsp;6.7</a>. The <code>:presence =&gt; true</code> argument is a one-element <em>options hash</em>; recall from <a class="ref" href="rails-flavored-ruby#sec-css_revisited">Section&nbsp;4.3.4</a> that curly braces are optional when passing hashes as the final argument in a method. (As noted in <a class="ref" href="filling-in-the-layout#sec-adding_to_the_layout">Section&nbsp;5.1.1</a>, the use of options hashes is a recurring theme in Rails.)</p>

<div class="label" id="code-validates_presence_of_name"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.7.</span> <span class="description">Validating the presence of a <code>name</code> attribute. <br /> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As discussed briefly in <a class="ref" href="a-demo-app#sec-putting_the_micro_in_microposts">Section&nbsp;2.3.2</a>, the use of <code>validates</code> is characteristic of Rails&nbsp;3. (In Rails&nbsp;2.3, we would write <code>validates_presence_of :name</code> instead.)</p>

<p><a class="ref" href="modeling-and-viewing-users-one#code-validates_presence_of_name">Listing&nbsp;6.7</a> may look like magic, but <code>validates</code> is just a method, as indeed is <code>attr_accessible</code>. An equivalent formulation of <a class="ref" href="modeling-and-viewing-users-one#code-validates_presence_of_name">Listing&nbsp;6.7</a> using parentheses is as follows:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">)</span>

  <span class="n">validates</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Let&rsquo;s drop into the console to see the effects of adding a validation to our User model:<sup class="footnote" id="fnref-6_15"><a href="#fn-6_15">15</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>Here <code>user.save</code> returns <code>false</code>, indicating a failed save. In the final command, we use the <code>valid?</code> method, which returns <code>false</code> when the object fails one or more validations, and <code>true</code> when all validations pass. (Recall from <a class="ref" href="rails-flavored-ruby#sec-objects_and_message_passing">Section&nbsp;4.2.3</a> that Ruby uses a question mark to indicate such true/false <em>boolean</em> methods.) In this case, we only have one validation, so we know which one failed, but it can still be helpful to check using the <code>errors</code> object generated on failure:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; [&quot;Name can&#39;t be blank&quot;]</span>
</pre></div>
</div>


<p>(The error message is a hint that Rails validates the presence of an attribute using the <code>blank?</code> method, which we saw at the end of <a class="ref" href="rails-flavored-ruby#sec-modifying_built_in_classes">Section&nbsp;4.4.3</a>.)</p>

<p>Now for the failing test. To ensure that our incipient test will fail, let&rsquo;s comment out the validation at this point (<a class="ref" href="modeling-and-viewing-users-one#code-commented_out_validation">Listing&nbsp;6.8</a>).</p>

<div class="label" id="code-commented_out_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.8.</span> <span class="description">Commenting out a validation to ensure a failing test. <br /> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="c1"># validates :name, :presence =&gt; true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As in the case of controller generation (e.g., <a class="ref" href="filling-in-the-layout#code-generate_users_controller">Listing&nbsp;5.23</a>), the model generate command in <a class="ref" href="modeling-and-viewing-users-one#code-generate_user_model">Listing&nbsp;6.1</a> produces an initial spec for testing users, but in this case it&rsquo;s practically blank (<a class="ref" href="modeling-and-viewing-users-one#code-default_user_spec">Listing&nbsp;6.9</a>).</p>

<div class="label" id="code-default_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.9.</span> <span class="description">The practically blank default User spec. <br /> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">pending</span> <span class="s2">&quot;add some examples to (or delete) </span><span class="si">#{</span><span class="bp">__FILE__</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This simply uses the <code>pending</code> method to indicate that we should fill the spec with something useful. We can see its effect by running the User model spec:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb 
<span class="go">*</span>


<span class="go">Finished in 0.01999 seconds</span>
<span class="go">1 example, 0 failures, 1 pending</span>

<span class="go">Pending:</span>
<span class="go">  User add some examples to (or delete)</span>
<span class="go">  /Users/mhartl/rails_projects/sample_app/spec/models/user_spec.rb</span>
<span class="go">  (Not Yet Implemented)</span>
</pre></div>
</div>


<p>We&rsquo;ll follow the advice of the default spec by filling it in with some RSpec examples, shown in <a class="ref" href="modeling-and-viewing-users-one#code-raw_user_spec">Listing&nbsp;6.10</a>.</p>

<div class="label" id="code-raw_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.10.</span> <span class="description">The initial user spec. <br /> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should create a new instance given valid attributes&quot;</span> <span class="k">do</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should require a name&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We&rsquo;ve seen <code>require</code> and <code>describe</code> before, most recently in <a class="ref" href="filling-in-the-layout#code-user_signup_spec">Listing&nbsp;5.28</a>. The next line is a <code>before(:each)</code> block; this was covered briefly in an exercise (<a class="ref" href="static-pages#code-pages_controller_spec_exercise">Listing&nbsp;3.33</a>), and all it does is run the code inside the block before each example&mdash;in this case setting the <code>@attr</code> instance variable to an initialization hash.</p>

<p>The first example is just a sanity check, verifying that the User model is basically working. It uses <code>User.create!</code> (read &ldquo;create bang&rdquo;), which works just like the <code>create</code> method we saw in <a class="ref" href="modeling-and-viewing-users-one#sec-creating_user_objects">Section&nbsp;6.1.3</a> except that it raises an <code>ActiveRecord::RecordInvalid</code> exception if the creation fails (similar to the <code>ActiveRecord::RecordNotFound</code> exception we saw in <a class="ref" href="modeling-and-viewing-users-one#sec-finding_user_objects">Section&nbsp;6.1.4</a>). As long as the attributes are valid, it won&rsquo;t raise any exceptions, and the test will pass.</p>

<p>The final line is the test for the presence of the <code>name</code> attribute&mdash;or rather, it <em>would</em> be the actual test, if it had anything in it. Instead, the test is just a stub, but a useful stub it is: it&rsquo;s a <em>pending spec</em>, which is a way to write a description of the application&rsquo;s behavior without worrying yet about the implementation. <a class="ref" href="modeling-and-viewing-users-one#code-default_user_spec">Listing&nbsp;6.9</a> shows an example of a pending spec using an explicit call to the <code>pending</code> method; in this case, since we have included only the&nbsp;<code>it</code> part of the example,</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should require a name&quot;</span>
</pre></div>
</div>


<p>RSpec infers the existence of a pending spec.</p>

<p>Pending specs are handled well by programs for running specs, as seen for Autotest in <a class="ref" href="modeling-and-viewing-users-one#fig-autotest_pending_spec">Figure&nbsp;6.5</a>, and the output of <code>rspec spec/</code> is similarly useful. Pending specs are useful as placeholders for tests we know we need to write at some point but don&rsquo;t want to deal with right now.</p>

<div class="label" id="fig-autotest_pending_spec"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/autotest_pending_spec.png" alt="autotest_pending_spec" /></span></div><div class="caption"><span class="header">Figure 6.5: </span><span class="description">Autotest (via <code>autotest</code>) with a pending User spec.&nbsp;<a href="http://railstutorial.org/images/figures/autotest_pending_spec-full.png">(full size)</a></span></div></div>


<p>In order to fill in the pending spec, we need a way to make an attributes hash with an invalid name. (The <code>@attr</code> hash is valid by construction, with a non-blank <code>name</code> attribute.) The <code>Hash</code> method <code>merge</code> does the trick, as we can see with <code>rails console</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:name =&gt; &quot;Example User&quot;, :email =&gt; &quot;user@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="go">=&gt; {:name =&gt; &quot;&quot;, :email =&gt; &quot;user@example.com&quot;}</span>
</pre></div>
</div>


<p>With <code>merge</code> in hand, we&rsquo;re ready to make the new spec (using a trick I&rsquo;ll explain momentarily), as seen in <a class="ref" href="modeling-and-viewing-users-one#code-failing_validates_name_spec">Listing&nbsp;6.11</a>.</p>

<div class="label" id="code-failing_validates_name_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.11.</span> <span class="description">A failing test for validation of the <code>name</code> attribute. <br /> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;should require a name&quot;</span> <span class="k">do</span>
    <span class="n">no_name_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">no_name_user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we use <code>merge</code> to make a new user called <code>no_name_user</code> with a blank name. The second line then uses the RSpec <code>should_not</code> method to verify that the resulting user is <em>not</em> valid. The trick I alluded to above is related to <code>be_valid</code>: we know from earlier in this section that a User object responds to the <code>valid?</code> boolean method. RSpec adopts the useful convention of allowing us to test <em>any</em> boolean method by dropping the question mark and prepending <code>be_</code>. In other words,</p>

<div class="code"><div class="highlight"><pre><span class="n">no_name_user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
</pre></div>
</div>


<p>is equivalent to</p>

<div class="code"><div class="highlight"><pre><span class="n">no_name_user</span><span class="o">.</span><span class="n">valid?</span><span class="o">.</span><span class="n">should_not</span> <span class="o">==</span> <span class="kp">true</span>
</pre></div>
</div>


<p>Since it sounds more like natural language, writing <code>should_not be_valid</code> is definitely more idiomatically correct RSpec.</p>

<p>With that, our new test should fail, which we can verify with Autotest or by running the <code>user_spec.rb</code> file using the <code>spec</code> script:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
<span class="go">.F</span>

<span class="go">1)</span>
<span class="go">&#39;User should require a name&#39; FAILED</span>
<span class="go">expected valid? to return false, got true</span>
<span class="go">./spec/models/user_spec.rb:14:</span>

<span class="go">2 examples, 1 failure</span>
</pre></div>
</div>


<p>Now uncomment the validation (i.e., revert <a class="ref" href="modeling-and-viewing-users-one#code-commented_out_validation">Listing&nbsp;6.8</a> back to <a class="ref" href="modeling-and-viewing-users-one#code-validates_presence_of_name">Listing&nbsp;6.7</a>) to get the test to pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
<span class="go">..</span>

<span class="go">2 examples, 0 failures</span>
</pre></div>
</div>


<p>Of course, we also want to validate the presence of email addresses. The test (<a class="ref" href="modeling-and-viewing-users-one#code-validates_email_spec">Listing&nbsp;6.12</a>) is analogous to the one for the <code>name</code> attribute.</p>

<div class="label" id="code-validates_email_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.12.</span> <span class="description">A test for presence of the <code>email</code> attribute. <br /> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;should require an email address&quot;</span> <span class="k">do</span>
    <span class="n">no_email_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">no_email_user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The implementation is also virtually the same, as seen in <a class="ref" href="modeling-and-viewing-users-one#code-validates_presence_of_email">Listing&nbsp;6.13</a>.</p>

<div class="label" id="code-validates_presence_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.13.</span> <span class="description">Validating the presence of the <code>name</code> and <code>email</code> attributes. <br /> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Now all the tests should pass, and the &ldquo;presence&rdquo; validations are complete.</p>

<div class="label" id="sec-length_validation"></div>


<h3><a id="sec-6_2_2" href="modeling-and-viewing-users-one#sec-length_validation" class="heading"><span class="number">6.2.2</span> Length validation</a></h3>


<p>We&rsquo;ve constrained our User model to require a name for each user, but we should go further: the user&rsquo;s names will be displayed on the sample site, so we should enforce some limit on their length. With all the work we did in <a class="ref" href="modeling-and-viewing-users-one#sec-presence_validation">Section&nbsp;6.2.1</a>, this step is easy.</p>

<p>We start with a test. There&rsquo;s no science to picking a maximum length; we&rsquo;ll just pull&nbsp;<code>50</code> out of thin air as a reasonable upper bound, which means verifying that names of&nbsp;<code>51</code> characters are too long   (<a class="ref" href="modeling-and-viewing-users-one#code-length_validation_test">Listing&nbsp;6.14</a>).</p>

<div class="label" id="code-length_validation_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.14.</span> <span class="description">A test for <code>name</code> length validation. <br /> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;should reject names that are too long&quot;</span> <span class="k">do</span>
    <span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">51</span>
    <span class="n">long_name_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="n">long_name</span><span class="p">))</span>
    <span class="n">long_name_user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>For convenience, we&rsquo;ve used &ldquo;string multiplication&rdquo; in <a class="ref" href="modeling-and-viewing-users-one#code-length_validation_test">Listing&nbsp;6.14</a> to make a string 51 characters long. We can see how this works using the console:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">51</span>
<span class="go">=&gt; &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">length</span>
<span class="go">=&gt; 51</span>
</pre></div>
</div>


<p>The test in <a class="ref" href="modeling-and-viewing-users-one#code-length_validation_test">Listing&nbsp;6.14</a> should fail. To get it to pass, we need to know about the validation argument to constrain length, <code>:length</code>, along with the <code>:maximum</code> parameter to enforce the upper bound (<a class="ref" href="modeling-and-viewing-users-one#code-length_validation">Listing&nbsp;6.15</a>).</p>

<div class="label" id="code-length_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.15.</span> <span class="description">Adding a length validation for the <code>name</code> attribute. <br /> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:length</span>   <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With our test suite passing again, we can move on to a more challenging validation: email format.</p>

<div class="label" id="sec-format_validation"></div>


<h3><a id="sec-6_2_3" href="modeling-and-viewing-users-one#sec-format_validation" class="heading"><span class="number">6.2.3</span> Format validation</a></h3>


<p>Our validations for the <code>name</code> attribute enforce only minimal constraints&mdash;any non-blank name under 51 characters will do&mdash;but of course the <code>email</code> attribute must satisfy more stringent requirements. So far we&rsquo;ve only rejected blank email addresses; in this section, we&rsquo;ll require email addresses to conform to the familiar pattern <code>user@example.com</code>.</p>

<p>Neither the tests nor the validation will be exhaustive, just good enough to accept most valid email addresses and reject most invalid ones. We&rsquo;ll start with a couple tests involving collections of valid and invalid addresses. To make these collections, it&rsquo;s worth knowing about a useful method for making arrays of strings, as seen in this console session:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="sx">%w[foo bar baz]</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo.com THE_USER@foo.bar.org first.last@foo.jp]</span>
<span class="go">=&gt; [&quot;user@foo.com&quot;, &quot;THE_USER@foo.bar.org&quot;, &quot;first.last@foo.jp&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="n">address</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">user@foo.com</span>
<span class="go">THE_USER@foo.bar.org</span>
<span class="go">first.last@foo.jp</span>
</pre></div>
</div>


<p>Here we&rsquo;ve iterated over the elements of the <code>addresses</code> array using the <code>each</code> method (<a class="ref" href="rails-flavored-ruby#sec-blocks">Section&nbsp;4.3.2</a>). With this technique in hand, we&rsquo;re ready to write some basic email format validation tests (<a class="ref" href="modeling-and-viewing-users-one#code-email_format_validation_tests">Listing&nbsp;6.16</a>).</p>

<div class="label" id="code-email_format_validation_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.16.</span> <span class="description">Tests for email format validation. <br /> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;should accept valid email addresses&quot;</span> <span class="k">do</span>
    <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo.com THE_USER@foo.bar.org first.last@foo.jp]</span>
    <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span>
      <span class="n">valid_email_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">address</span><span class="p">))</span>
      <span class="n">valid_email_user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_valid</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should reject invalid email addresses&quot;</span> <span class="k">do</span>
    <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo,com user_at_foo.org example.user@foo.]</span>
    <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span>
      <span class="n">invalid_email_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">address</span><span class="p">))</span>
      <span class="n">invalid_email_user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As noted above, these are far from exhaustive, but we do check the common valid email forms <code>user@foo.com</code>, <code>THE_USER@foo.bar.org </code> (uppercase, underscores, and compound domains), and <code>first.last@foo.jp</code> (the standard corporate username <code>first.last</code>, with a two-letter top-level domain&nbsp;<code>jp</code>), along with several invalid forms.</p>

<p>The application code for email format validation uses a <em>regular expression</em> (or <em>regex</em>) to define the format, along with the <code>:format</code> argument to the <code>validates</code> method (<a class="ref" href="modeling-and-viewing-users-one#code-validates_format_of_email">Listing&nbsp;6.17</a>).</p>

<div class="label" id="code-validates_format_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.17.</span> <span class="description">Validating the email format with a regular expression. <br /> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">email_regex</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:length</span>   <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:format</span>   <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">email_regex</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here <code>email_regex</code> is a <em>regular expression</em>, also known as a <em>regex</em>. The code</p>

<div class="code"><div class="highlight"><pre>  <span class="n">email_regex</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:format</span>   <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">email_regex</span> <span class="p">}</span>
</pre></div>
</div>


<p>ensures that only email addresses that match the pattern will be considered valid.</p>

<p>So, where does the pattern come from? Regular expressions consist of a terse (some would say <a href="http://catb.org/jargon/html/L/line-noise.html">unreadable</a>) language for matching text patterns; learning to construct regexes is an art, and to get you started I&rsquo;ve broken <code>email_regex</code> into bite-sized pieces (<a class="ref" href="modeling-and-viewing-users-one#table-email_regex">Table&nbsp;6.1</a>).<sup class="footnote" id="fnref-6_16"><a href="#fn-6_16">16</a></sup> To really learn about regular expressions, though, I consider the amazing <a href="http://www.rubular.com/">Rubular</a> regular expression editor (<a class="ref" href="modeling-and-viewing-users-one#fig-rubular">Figure&nbsp;6.6</a>) to be simply essential.<sup class="footnote" id="fnref-6_17"><a href="#fn-6_17">17</a></sup> The Rubular website has a beautiful interactive interface for making regular expressions, along with a handy regex quick reference. I encourage you to study <a class="ref" href="modeling-and-viewing-users-one#table-email_regex">Table&nbsp;6.1</a> with a browser window open to Rubular&mdash;no amount of reading about regular expressions can replace a couple of hours playing with Rubular.</p>

<div class="label" id="table-email_regex"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>Expression</strong></th><th class="align_left"><strong>Meaning</strong></th></tr><tr class="top_bar"><td class="align_left"><tt class="verb">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</tt></td><td class="align_left">full regex</td></tr><tr><td class="align_left"><tt class="verb">/</tt></td><td class="align_left">start of regex</td></tr><tr><td class="align_left"><tt class="verb">\A</tt></td><td class="align_left">match start of a string</td></tr><tr><td class="align_left"><tt class="verb">[\w+\-.]+</tt></td><td class="align_left">at least one word character, plus, hyphen, or dot</td></tr><tr><td class="align_left"><tt class="verb">@</tt></td><td class="align_left">literal &ldquo;at sign&rdquo;</td></tr><tr><td class="align_left"><tt class="verb">[a-z\d\-.]+</tt></td><td class="align_left">at least one letter, digit, hyphen, or dot</td></tr><tr><td class="align_left"><tt class="verb">\.</tt></td><td class="align_left">literal dot</td></tr><tr><td class="align_left"><tt class="verb">[a-z]+</tt></td><td class="align_left">at least one letter</td></tr><tr><td class="align_left"><tt class="verb">\z</tt></td><td class="align_left">match end of a string</td></tr><tr><td class="align_left"><tt class="verb">/</tt></td><td class="align_left">end of regex</td></tr><tr><td class="align_left"><tt class="verb">i</tt></td><td class="align_left">case insensitive</td></tr></table></div><div class="caption"><span class="header">Table 6.1: </span><span class="description">Breaking down the email regex from <a class="ref" href="modeling-and-viewing-users-one#code-validates_format_of_email">Listing&nbsp;6.17</a>.</span></div></div>


<p>By the way, there actually exists a full regex for matching email addresses according to the official standard, but it&rsquo;s really not worth the trouble. The one in <a class="ref" href="modeling-and-viewing-users-one#code-validates_format_of_email">Listing&nbsp;6.17</a> is fine, maybe even better than the official one.<sup class="footnote" id="fnref-6_18"><a href="#fn-6_18">18</a></sup></p>

<div class="label" id="fig-rubular"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/rubular.png" alt="rubular" /></span></div><div class="caption"><span class="header">Figure 6.6: </span><span class="description">The awesome  <a href="http://www.rubular.com/">Rubular</a> regular expression editor.&nbsp;<a href="http://railstutorial.org/images/figures/rubular-full.png">(full size)</a></span></div></div>


<p>The tests should all be passing now. (In fact, the tests for valid email addresses should have been passing all along; since regexes are notoriously error-prone, the valid email tests are there mainly as a sanity check on <code>email_regex</code>.) This means that there&rsquo;s only one constraint left: enforcing the email addresses to be unique.</p>

<div class="label" id="sec-uniqueness_validation"></div>


<h3><a id="sec-6_2_4" href="modeling-and-viewing-users-one#sec-uniqueness_validation" class="heading"><span class="number">6.2.4</span> Uniqueness validation</a></h3>


<p>To enforce uniqueness of email addresses (so that we can use them as usernames), we&rsquo;ll be using the <code>:unique</code> option to the <code>validates</code> method. But be warned: there&rsquo;s a <em>major</em> caveat, so don&rsquo;t just skim this section&mdash;read it carefully.</p>

<p>We&rsquo;ll start, as usual, with our tests. In our previous model tests, we&rsquo;ve mainly used <code>User.new</code>, which just creates a Ruby object in memory, but for uniqueness tests we actually need to put a record into the database.<sup class="footnote" id="fnref-6_19"><a href="#fn-6_19">19</a></sup> The (first) duplicate email test appears in <a class="ref" href="modeling-and-viewing-users-one#code-validates_uniqueness_of_email_test">Listing&nbsp;6.18</a>.</p>

<div class="label" id="code-validates_uniqueness_of_email_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.18.</span> <span class="description">A test for the rejection of duplicate email addresses. <br /> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;should reject duplicate email addresses&quot;</span> <span class="k">do</span>
    <span class="c1"># Put a user with given email address into the database.</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="n">user_with_duplicate_email</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="n">user_with_duplicate_email</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The method here is to create a user and then try to make another one with the same email address. (We use the noisy method <code>create!</code>, first seen in <a class="ref" href="modeling-and-viewing-users-one#code-raw_user_spec">Listing&nbsp;6.10</a>, so that it will raise an exception if anything goes wrong. Using <code>create</code>, without the bang&nbsp;<code>!</code>, risks having a silent error in our test, a potential source of elusive bugs.) We can get this test to pass with the code in <a class="ref" href="modeling-and-viewing-users-one#code-validates_uniqueness_of_email">Listing&nbsp;6.19</a>.<sup class="footnote" id="fnref-6_20"><a href="#fn-6_20">20</a></sup></p>

<div class="label" id="code-validates_uniqueness_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.19.</span> <span class="description">Validating the uniqueness of email addresses. <br /> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span>   <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:format</span>     <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">email_regex</span> <span class="p">},</span>
                    <span class="ss">:uniqueness</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We&rsquo;re not quite done, though. Email addresses are case-insensitive&mdash;<code>foo@bar.com</code> goes to the same place as <code>FOO@BAR.COM</code> or <code>FoO@BAr.coM</code>&mdash;so our validation should cover this case as well. We test for this with the code in <a class="ref" href="modeling-and-viewing-users-one#code-validates_uniqueness_of_email_case_insensitive_test">Listing&nbsp;6.20</a>.</p>

<div class="label" id="code-validates_uniqueness_of_email_case_insensitive_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.20.</span> <span class="description">A test for the rejection of duplicate email addresses, insensitive to case. <br /> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;should reject email addresses identical up to case&quot;</span> <span class="k">do</span>
    <span class="n">upcased_email</span> <span class="o">=</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:email</span><span class="o">].</span><span class="n">upcase</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">upcased_email</span><span class="p">))</span>
    <span class="n">user_with_duplicate_email</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="n">user_with_duplicate_email</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we are using the <code>upcase</code> method on strings (seen briefly in <a class="ref" href="rails-flavored-ruby#sec-blocks">Section&nbsp;4.3.2</a>). This test does the same thing as the first duplicate email test, but with an upper-case email address instead. If this test feels a little abstract, go ahead and fire up the console:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:name =&gt; &quot;Example User&quot;, :email =&gt; &quot;user@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">upcased_email</span> <span class="o">=</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:email</span><span class="o">].</span><span class="n">upcase</span>
<span class="go">=&gt; &quot;USER@EXAMPLE.COM&quot;</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">upcased_email</span><span class="p">))</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_duplicate_email</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_duplicate_email</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Of course, currently <code>user_with_duplicate_email.valid?</code> is <code>true</code>, since this is a failing test, but we want it to be <code>false</code>. Fortunately, <code>:uniqueness</code> accepts an option, <code>:case_sensitive</code>, for just this purpose (<a class="ref" href="modeling-and-viewing-users-one#code-validates_uniqueness_of_email_case_insensitive">Listing&nbsp;6.21</a>).</p>

<div class="label" id="code-validates_uniqueness_of_email_case_insensitive"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.21.</span> <span class="description">Validating the uniqueness of email addresses, ignoring case. <br /> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span>   <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:format</span>     <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">email_regex</span> <span class="p">},</span>
                    <span class="ss">:uniqueness</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:case_sensitive</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that we have simply replaced <code>true</code> with <code>:case_sensitive =&gt; false</code>; Rails infers in this case that <code>:uniqueness</code> should be <code>true</code>. At this point, our application (sort-of) enforces email uniqueness, and our test suite should pass.</p>

<div class="label" id="sec-the_caveat"></div>


<h4><a id="sec-6_2_4_1" href="modeling-and-viewing-users-one#sec-the_caveat" class="heading">The uniqueness caveat</a></h4>


<p>There&rsquo;s just one small problem, the caveat alluded to above:</p>

<p><strong>Using <code>validates :uniqueness</code> does not guarantee uniqueness.</strong></p>

<p>D&rsquo;oh! But what can go wrong? Here&rsquo;s what:</p>

<ol>
<li>Alice signs up for the sample app, with address <code>alice@wonderland.com</code>.</li>
<li>Alice accidentally clicks on &ldquo;Submit&rdquo; <em>twice</em>, sending two requests in quick succession.</li>
<li>The following sequence occurs: request 1 creates a user in memory that passes validation, request 2 does the same, request&nbsp;1&rsquo;s user gets saved, request&nbsp;2&rsquo;s user gets saved.</li>
<li>Result: two user records with the exact same email address, despite the uniqueness validation.</li>
</ol>


<p>If the above sequence seems implausible, believe me, it isn&rsquo;t: it happens on any Rails website with significant traffic.<sup class="footnote" id="fnref-6_21"><a href="#fn-6_21">21</a></sup> Luckily, the solution is straightforward to implement; we just need to enforce uniqueness at the database level as well. Our method is to create a database <em>index</em> on the email column, and then require that the index be unique.</p>

<p>The email index represents an update to our data modeling requirements, which (as discussed in <a class="ref" href="modeling-and-viewing-users-one#sec-database_migrations">Section&nbsp;6.1.1</a>) is handled in Rails using migrations. We saw in <a class="ref" href="modeling-and-viewing-users-one#sec-database_migrations">Section&nbsp;6.1.1</a> that generating the User model automatically created a new migration (<a class="ref" href="modeling-and-viewing-users-one#code-users_migration">Listing&nbsp;6.2</a>); in the present case, we are adding structure to an existing model, so we need to create a migration directly using the <code>migration</code> generator:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_email_uniqueness_index
</pre></div>
</div>


<p>Unlike the migration for users, the email uniqueness migration is not pre-defined, so we need to fill in its contents with <a class="ref" href="modeling-and-viewing-users-one#code-email_uniqueness_index">Listing&nbsp;6.22</a>.<sup class="footnote" id="fnref-6_22"><a href="#fn-6_22">22</a></sup></p>

<div class="label" id="code-email_uniqueness_index"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.22.</span> <span class="description">The migration for enforcing email uniqueness. <br /> <code>db/migrate/&lt;timestamp&gt;_add_email_uniqueness_index.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddEmailUniquenessIndex</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">add_index</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">remove_index</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This uses a Rails method called <code>add_index</code> to add an index on the <code>email</code> column of the <code>users</code> table. The index by itself doesn&rsquo;t enforce uniqueness, but the option <code>:unique =&gt; true</code> does.</p>

<p>The final step is to migrate the database:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>


<p>Now the Alice scenario above will work fine: the database will save a user record based on the first request, and will reject the second save for violating the uniqueness constraint. (An error will appear in the Rails log, but that doesn&rsquo;t do any harm. You can actually catch the <code>ActiveRecord::StatementInvalid</code> exception that gets raised&mdash;see <a href="http://github.com/insoshi/insoshi/blob/master/app/controllers/people_controller.rb">Insoshi</a> for an example&mdash;but in this tutorial we won&rsquo;t bother with this step.) Adding this index on the email attribute accomplishes a second goal, alluded to briefly in <a class="ref" href="modeling-and-viewing-users-one#sec-finding_user_objects">Section&nbsp;6.1.4</a>: it fixes an efficiency problem in <code>find_by_email</code> (<a class="ref" href="modeling-and-viewing-users-one#sidebar-database_indices">Box&nbsp;6.2</a>).</p>

<div class="label" id="sidebar-database_indices"></div>


<div class="sidebar"><span class="title"><span class="header">Box 6.2.</span><span class="description">Database indices</span></span>
<p>When creating a column in a database, it is important to consider if we will need to <em>find</em> records by that column. Consider, for example, the <code>email</code> attribute created by the migration in <a class="ref" href="modeling-and-viewing-users-one#code-users_migration">Listing&nbsp;6.2</a>. When we allow users to sign in to the sample app starting in <a class="ref" href="sign-up#top">Chapter&nbsp;8</a>, we will need to find the user record corresponding to the submitted email address; unfortunately, based on the na&iuml;ve data model, the only way to find a user by email address is to look through <em>each</em> user row in the database and compare its email attribute to the given email. This is known in the database business as a <em>full-table scan</em>, and for a real site with thousands of users it is a <a href="http://catb.org/jargon/html/B/Bad-Thing.html">Bad Thing</a>.</p>

<p>Putting an index on the email column fixes the problem. To understand a database index, it&rsquo;s helpful to consider the analogy of a book index. In a book, to find all the occurrences of a given string, say &ldquo;foobar&rdquo;, you would have to scan each page for &ldquo;foobar&rdquo;. With a book index, on the other hand, you can just look up &ldquo;foobar&rdquo; in the index to see all the pages containing &ldquo;foobar&rdquo;. A database index works essentially the same way.</p>
</div>




<div class="label" id="sec-viewing_users"></div>


<h2><a id="sec-6_3" href="modeling-and-viewing-users-one#sec-viewing_users" class="heading"><span class="number">6.3</span> Viewing users</a></h2>


<p>We&rsquo;re not quite done with the basic user model&mdash;we still need to add passwords, a task for <a class="ref" href="modeling-and-viewing-users-two#top">Chapter&nbsp;7</a>&mdash;but we do have enough in place to make a minimalist page for showing user information. This will allow a gentle introduction to the REST style of organizing the actions for our site&rsquo;s users. Since this is just a rough demonstration for now, there are no tests in this section; we&rsquo;ll add tests when we flesh out the user view in <a class="ref" href="modeling-and-viewing-users-two#sec-better_user_views">Section&nbsp;7.3</a>.</p>

<div class="label" id="sec-rails_environments"></div>


<h3><a id="sec-6_3_1" href="modeling-and-viewing-users-one#sec-rails_environments" class="heading"><span class="number">6.3.1</span> Debug and Rails environments</a></h3>


<p>As preparation for adding dynamic pages to our sample application, now is a good time to add some debug information to our site layout (<a class="ref" href="modeling-and-viewing-users-one#code-rails_debug">Listing&nbsp;6.23</a>). This displays some useful information about each page using the built-in <code>debug</code> method and <code>params</code> variable (which we&rsquo;ll learn more about in <a class="ref" href="modeling-and-viewing-users-one#sec-users_show">Section&nbsp;6.3.2</a>), as seen in <a class="ref" href="modeling-and-viewing-users-one#fig-home_page_with_debug_rails_3">Figure&nbsp;6.7</a>.</p>

<div class="label" id="code-rails_debug"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.23.</span> <span class="description">Adding some debug information to the site layout. <br /> <code>app/views/layouts/application.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  .
  .
  .
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      .
      .
      .
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/footer&#39;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>Since we don&rsquo;t want to display debug information to users of a deployed application, we use</p>

<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
</pre></div>
</div>


<p>to restrict the debug information to the <em>development environment</em>. Though we&rsquo;ve seen evidence of Rails environments before (most recently in <a class="ref" href="modeling-and-viewing-users-one#sec-creating_user_objects">Section&nbsp;6.1.3</a>), this is the first time it has mattered to us.</p>

<div class="label" id="fig-home_page_with_debug_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_with_debug_rails_3.png" alt="home_page_with_debug_rails_3" /></span></div><div class="caption"><span class="header">Figure 6.7: </span><span class="description">The sample application Home page (<a href="http://localhost:3000/"><tt>/</tt></a>) with debug information at the bottom.&nbsp;<a href="http://railstutorial.org/images/figures/home_page_with_debug_rails_3-full.png">(full size)</a></span></div></div>


<p>Rails comes equipped with three environments: <code>test</code>, <code>development</code>, and <code>production</code>.<sup class="footnote" id="fnref-6_23"><a href="#fn-6_23">23</a></sup> The default environment for the Rails console is <code>development</code>:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console </span>
<span class="go">Loading development environment (Rails 3.0.12)</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span>
<span class="go">=&gt; &quot;development&quot;</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">test?</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>As you can see, Rails provides a <code>Rails</code> object with an <code>env</code> attribute and associated environment boolean methods. In particular, <code>Rails.env.development?</code> is <code>true</code> only in a development environment, so the Embedded Ruby</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>won&rsquo;t be inserted into production applications or tests. (Inserting the debug information into tests probably doesn&rsquo;t do any harm, but it probably doesn&rsquo;t do any good, either, so it&rsquo;s best to restrict the debug display to development only.)</p>

<p>If you ever need to run a console in a different environment (to debug a test, for example), you can pass the environment as a parameter to the <code>console</code> script:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console test</span>
<span class="go">Loading test environment (Rails 3.0.12)</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span>
<span class="go">=&gt; &quot;test&quot;</span>
</pre></div>
</div>


<p>As with the console, <code>development</code> is the default environment for the local Rails server, but you can also run it in a different environment:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails server --environment production
</pre></div>
</div>


<p>If you view your app running in production, it won&rsquo;t work without a production database, which we can create by running <code>rake db:migrate</code> in production:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate <span class="nv">RAILS_ENV</span><span class="o">=</span>production
</pre></div>
</div>


<p>(I find it confusing that the console, server, and migrate commands specify non-default environments in three mutually incompatible ways, which is why I bothered showing all three.)</p>

<p>By the way, if you have deployed your sample app to Heroku, you can see its environment using the <code>heroku</code> command, which provides its own (remote) console:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ heroku console</span>
<span class="go">Ruby console for yourapp.heroku.com</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span>
<span class="go">=&gt; &quot;production&quot;</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">production?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Naturally, since Heroku is a platform for production sites, it runs each application in a production environment.</p>

<div class="label" id="sec-users_show"></div>


<h3><a id="sec-6_3_2" href="modeling-and-viewing-users-one#sec-users_show" class="heading"><span class="number">6.3.2</span> User model, view, controller</a></h3>


<p>In order to make a page to view a user, we&rsquo;ll use the User <em>model</em> to put a user into the database, make a <em>view</em> to display some user information, and then add an action to the Users <em>controller</em> to handle the browser request. In other words, for the first time in this tutorial, we&rsquo;ll see in one place all three elements of the model-view-controller architecture first discussed in <a class="ref" href="beginning#sec-mvc">Section&nbsp;1.2.6</a>.</p>

<p>Our first step is to create a user using the console, which we&rsquo;ll take care <em>not</em> to start in a sandbox since this time the whole point is to save a record to the database:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="go">Loading development environment (Rails 3.0.12)</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-07 23:05:14&quot;, updated_at: &quot;2010-01-07 23:05:14&quot;&gt;</span>
</pre></div>
</div>


<p>To double-check that this worked, let&rsquo;s look at the row in the development database using the SQLite Database Browser (<a class="ref" href="modeling-and-viewing-users-one#fig-sqlite_user_row">Figure&nbsp;6.8</a>). Note that the columns correspond to the attributes of the data model defined in <a class="ref" href="modeling-and-viewing-users-one#sec-user_model">Section&nbsp;6.1</a>.</p>

<div class="label" id="fig-sqlite_user_row"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sqlite_user_row.png" alt="sqlite_user_row" /></span></div><div class="caption"><span class="header">Figure 6.8: </span><span class="description">A user row in the SQLite database <code>db/development.sqlite3</code>.&nbsp;<a href="http://railstutorial.org/images/figures/sqlite_user_row-full.png">(full size)</a></span></div></div>


<p>Next comes the view, which is minimalist to emphasize that this is just a demonstration (<a class="ref" href="modeling-and-viewing-users-one#code-stub_user_view">Listing&nbsp;6.24</a>). We use the standard Rails location for showing a user, <code>app/views/users/show.html.erb</code>; unlike the <code>new.html.erb</code> view, which we created with the generator in <a class="ref" href="filling-in-the-layout#code-generate_users_controller">Listing&nbsp;5.23</a>, the <code>show.html.erb</code> file doesn&rsquo;t currently exist, so you&rsquo;ll have to create it by hand.</p>

<div class="label" id="code-stub_user_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.24.</span> <span class="description">A stub view for showing user information. <br /> <code>app/views/users/show.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>, <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>This view uses Embedded Ruby to display the user&rsquo;s name and email address, assuming the existence of an instance variable called <code>@user</code>. Of course, eventually the real user show page will look very different, and won&rsquo;t display the email address publicly.</p>

<p>Finally, we&rsquo;ll add the <code>show</code> action to the Users controller (corresponding to the <code>show.html.erb</code> view) with the code in <a class="ref" href="modeling-and-viewing-users-one#code-user_show_action">Listing&nbsp;6.25</a>, which defines the <code>@user</code> instance variable needed by the view.</p>

<div class="label" id="code-user_show_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.25.</span> <span class="description">The Users controller with a <code>show</code> action. <br /> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Sign up&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we&rsquo;ve gotten a little ahead of ourselves by using the standard Rails <code>params</code> object to retrieve the user&nbsp;id. When we make the appropriate request to the Users controller, <code>params[:id]</code> will be the user id&nbsp;<code>1</code>, so the effect is the same as the <code>find</code> command</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>we saw in <a class="ref" href="modeling-and-viewing-users-one#sec-finding_user_objects">Section&nbsp;6.1.4</a>.</p>

<p>Although the <code>show</code> view and action are now both defined, we still don&rsquo;t have a way to view the page itself. This requires defining the proper rule in the Rails routes file, as we&rsquo;ll see in the next section.</p>

<div class="label" id="sec-a_users_resource"></div>


<h3><a id="sec-6_3_3" href="modeling-and-viewing-users-one#sec-a_users_resource" class="heading"><span class="number">6.3.3</span> A Users resource</a></h3>


<p>Our method for displaying the user show page will follow the conventions of the REST architecture favored in Rails applications. This style is based on the ideas of <em>representational state transfer</em> identified and named by computer scientist <a href="http://en.wikipedia.org/wiki/Roy_Fielding">Roy Fielding</a> in his doctoral dissertation <em>Architectural Styles and the Design of Network-based Software Architectures</em>.<sup class="footnote" id="fnref-6_24"><a href="#fn-6_24">24</a></sup> The REST design style emphasizes representing data as <em>resources</em> that can be created, shown, updated, or destroyed&mdash;four actions corresponding to the four fundamental operations <tt>POST</tt>, <tt>GET</tt>, <tt>PUT</tt>, and <tt>DELETE</tt> defined by the <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP standard</a> (<a class="ref" href="static-pages#sidebar-get_etc">Box&nbsp;3.1</a>).</p>

<p>When following REST principles, resources are typically referenced using the resource name and a unique identifier. What this means in the context of users&mdash;which we&rsquo;re now thinking of as a Users <em>resource</em>&mdash;is that we should view the user with id&nbsp;<code>1</code> by issuing a <tt>GET</tt> request to the URL <tt>/users/1</tt>. Here the <code>show</code> action is <em>implicit</em> in the type of request&mdash;when Rails&rsquo; REST features are activated, <tt>GET</tt> requests are automatically handled by the <code>show</code> action.</p>

<div class="label" id="fig-user_show_exception_caught"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_exception_caught.png" alt="user_show_exception_caught" /></span></div><div class="caption"><span class="header">Figure 6.9: </span><span class="description">The initial effect of hitting  <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a>.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_exception_caught-full.png">(full size)</a></span></div></div>


<p>Unfortunately, the URL <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a> doesn&rsquo;t work quite yet due to a routing error (<a class="ref" href="modeling-and-viewing-users-one#fig-user_show_exception_caught">Figure&nbsp;6.9</a>). We can get the REST-style Users URL to work by adding users as a resource to <code>config/routes.rb</code>, as seen in <a class="ref" href="modeling-and-viewing-users-one#code-users_resource">Listing&nbsp;6.26</a>.</p>

<div class="label" id="code-users_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.26.</span> <span class="description">Adding a Users resource to the routes file. <br /> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>

  <span class="n">match</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span>  <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;users#new&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>After adding the routes for the Users resource, the URL <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a> works perfectly (<a class="ref" href="modeling-and-viewing-users-one#fig-user_show_rails_3">Figure&nbsp;6.10</a>).</p>

<div class="label" id="fig-user_show_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_rails_3.png" alt="user_show_rails_3" /></span></div><div class="caption"><span class="header">Figure 6.10: </span><span class="description">The user show page at  <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a> after adding a Users resource.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_rails_3-full.png">(full size)</a></span></div></div>


<p>You might have noticed that <a class="ref" href="modeling-and-viewing-users-one#code-users_resource">Listing&nbsp;6.26</a> removed the line</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s2">&quot;users/new&quot;</span>
</pre></div>
</div>


<p>last seen in <a class="ref" href="filling-in-the-layout#code-signup_route">Listing&nbsp;5.29</a>. This is because the one additional resource line in <a class="ref" href="modeling-and-viewing-users-one#code-users_resource">Listing&nbsp;6.26</a> doesn&rsquo;t just add a working <tt>/users/1</tt> URL; it endows our sample application with all the actions needed for a RESTful Users resource,<sup class="footnote" id="fnref-6_25"><a href="#fn-6_25">25</a></sup> along with a large number of named routes (<a class="ref" href="filling-in-the-layout#sec-named_routes">Section&nbsp;5.2.3</a>) for generating user URLs. The resulting correspondence of URLs, actions, and named routes is shown in <a class="ref" href="modeling-and-viewing-users-one#table-RESTful_users">Table&nbsp;6.2</a>. (Compare to <a class="ref" href="a-demo-app#table-demo_RESTful_users">Table&nbsp;2.2</a>.) Over the course of the next three chapters, we&rsquo;ll cover all of the other entries in <a class="ref" href="modeling-and-viewing-users-one#table-RESTful_users">Table&nbsp;6.2</a> as we fill in all the actions necessary to make Users a fully RESTful resource.</p>

<div class="label" id="table-RESTful_users"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URL</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>Named route</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left"><tt>/users</tt></td><td class="align_left"><code>index</code></td><td class="align_left"><code>users_path</code></td><td class="align_left">page to list all users</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left"><tt>/users/1</tt></td><td class="align_left"><code>show</code></td><td class="align_left"><code>user_path(1)</code></td><td class="align_left">page to show user with id <code>1</code></td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left"><tt>/users/new</tt></td><td class="align_left"><code>new</code></td><td class="align_left"><code>new_user_path</code></td><td class="align_left">page to make a new user (signup)</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left"><tt>/users</tt></td><td class="align_left"><code>create</code></td><td class="align_left"><code>users_path</code></td><td class="align_left">create a new user</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left"><tt>/users/1/edit</tt></td><td class="align_left"><code>edit</code></td><td class="align_left"><code>edit_user_path(1)</code></td><td class="align_left">page to edit user with id <code>1</code></td></tr><tr><td class="align_left"><tt>PUT</tt></td><td class="align_left"><tt>/users/1</tt></td><td class="align_left"><code>update</code></td><td class="align_left"><code>user_path(1)</code></td><td class="align_left">update user with id <code>1</code></td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left"><tt>/users/1</tt></td><td class="align_left"><code>destroy</code></td><td class="align_left"><code>user_path(1)</code></td><td class="align_left">delete user with id <code>1</code></td></tr></table></div><div class="caption"><span class="header">Table 6.2: </span><span class="description">RESTful routes provided by the Users resource in <a class="ref" href="modeling-and-viewing-users-one#code-users_resource">Listing&nbsp;6.26</a>.</span></div></div>




<div class="label" id="sec-params_in_debug"></div>


<h4><a id="sec-6_3_3_1" href="modeling-and-viewing-users-one#sec-params_in_debug" class="heading"><code>params</code> in <code>debug</code></a></h4>


<p>Before leaving the user show page, we&rsquo;ll take a moment to examine the debug information produced by <a class="ref" href="modeling-and-viewing-users-one#code-rails_debug">Listing&nbsp;6.23</a>. If you look closely at <a class="ref" href="modeling-and-viewing-users-one#fig-user_show_rails_3">Figure&nbsp;6.10</a>, you&rsquo;ll see that it includes useful information about the page being rendered:<sup class="footnote" id="fnref-6_26"><a href="#fn-6_26">26</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span> <span class="kt">!map</span><span class="l-Scalar-Plain">:ActiveSupport::HashWithIndifferentAccess</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">show</span>
<span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">&quot;1&quot;</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
</pre></div>
</div>


<p>This is a YAML<sup class="footnote" id="fnref-6_27"><a href="#fn-6_27">27</a></sup> representation of <code>params</code>, which (as hinted at by the name <code>HashWithIndifferentAccess</code>) is basically a hash.  We see that its
controller is <code>users</code>, its action is <code>show</code>, and its <code>id</code> attribute is <code>"1"</code>. Although you will rarely have occasion to use <code>params[:controller]</code> or <code>params[:action]</code>, using <code>params[:id]</code> to pull out the&nbsp;id from the URL is a common Rails idiom. In particular, we used the code</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>in <a class="ref" href="modeling-and-viewing-users-one#code-user_show_action">Listing&nbsp;6.25</a> to find the user with id&nbsp;<code>1</code>. (The <code>find</code> method knows how to convert the string&nbsp;<code>"1"</code> into the integer&nbsp;<code>1</code>.)</p>

<p>The <code>debug</code> information often provides useful feedback when developing Rails applications, and I suggest getting in the habit of checking it whenever your application doesn&rsquo;t behave as expected.</p>

<h2><a id="sec-6_4" href="modeling-and-viewing-users-one#sec-6_4" class="heading"><span class="number">6.4</span> Conclusion</a></h2>


<p>This chapter is the first half of the two-step process of creating a working User model. Our users now have <code>name</code> and <code>email</code> attributes, together with validations enforcing several important constraints on their values. We&rsquo;ve also taken a first small step toward a working user show page and a Users resource based on the principles of representational state transfer (REST). In <a class="ref" href="modeling-and-viewing-users-two#top">Chapter&nbsp;7</a>, we&rsquo;ll complete the process by adding user passwords and a more useful user view.</p>

<p>If you&rsquo;re using Git, now would be a good time to commit if you haven&rsquo;t done so in a while:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finished first cut of the User model&quot;</span>
</pre></div>
</div>


<h2><a id="sec-6_5" href="modeling-and-viewing-users-one#sec-6_5" class="heading"><span class="number">6.5</span> Exercises</a></h2>




<ol>
<li>Read through the Rails API entry for <code>ActiveRecord::Base</code> to get a sense of its capabilities.</li>
<li>Study the entry in the Rails API for the <code>validates</code> method to learn more about its capabilities and options.</li>
<li>Spend a couple hours playing with <a href="http://www.rubular.com/">Rubular</a>.</li>

</ol>




<div class="navigation">  <a class="prev_page" href="filling-in-the-layout#top">
    &laquo;&nbsp;<span class="number">Chapter 5</span> Filling in the layout
  </a>
  <a class="next_page" href="modeling-and-viewing-users-two#top">
    <span class="number">Chapter 7</span> Modeling and viewing users, part II&nbsp;&raquo;
  </a>
</div><div class="footnotes">
<ol>
<li id="fn-6_1"><a href="http://gomockingbird.com/">Mockingbird</a> doesn&rsquo;t support custom images like the profile photo in <a class="ref" href="modeling-and-viewing-users-one#fig-profile_mockup">Figure&nbsp;6.1</a>; I put that in by hand using <a href="http://www.adobe.com/products/fireworks/">Adobe Fireworks</a>. The hippo here is from <a href="http://www.flickr.com/photos/43803060@N00/24308857/">http://www.flickr.com/photos/43803060@N00/24308857/</a>.&nbsp;<a class="arrow" href="#fnref-6_1">&uarr;</a></li>
<li id="fn-6_2">The name comes from the &ldquo;<a href="http://en.wikipedia.org/wiki/Active_record_pattern">active record pattern</a>&rdquo;, identified and named in <em>Patterns of Enterprise Application Architecture</em> by Martin Fowler.&nbsp;<a class="arrow" href="#fnref-6_2">&uarr;</a></li>
<li id="fn-6_3">Pronounced &ldquo;ess-cue-ell&rdquo;, though the alternate pronunciation &ldquo;sequel&rdquo; is also common.&nbsp;<a class="arrow" href="#fnref-6_3">&uarr;</a></li>
<li id="fn-6_4">In its earliest incarnations, Rails did require knowledge of an SQL&nbsp;DDL.  Even after Rails added migrations, setting up the old default database (MySQL) was quite involved. Happily, as noted in <a class="ref" href="beginning#sec-rails_server">Section&nbsp;1.2.5</a>, Rails now uses SQLite by default, which stores its data as a simple file&mdash;no setup required.&nbsp;<a class="arrow" href="#fnref-6_4">&uarr;</a></li>
<li id="fn-6_5">Occasionally, it is necessary to pierce this abstraction layer, but one design goal of this tutorial is to make all the code database-independent. (Indeed, this is a worthy goal in general.) In case you ever do need to write database-specific code to deploy on Heroku, you should know that they use the excellent <a href="http://www.postgresql.org/">PostgreSQL</a> (&ldquo;post-gres-cue-ell&rdquo;) database. PostgreSQL is free, open-source, and cross-platform; if you develop PostgreSQL-specific applications, you can install it locally, and configure Rails to use it in development by editing the <code>config/database.yml</code> file. Such configuration is beyond the scope of this tutorial, but there are lots of resources on the web; use a search engine to find the most up-to-date information for your platform.&nbsp;<a class="arrow" href="#fnref-6_5">&uarr;</a></li>
<li id="fn-6_6">By using an email address as the username, we open the theoretical possibility of communicating with our users at a future date.&nbsp;<a class="arrow" href="#fnref-6_6">&uarr;</a></li>
<li id="fn-6_7">Don&rsquo;t worry about exactly how the <code>t</code>&nbsp;object manages to do this; the beauty of <em>abstraction layers</em> is that we don&rsquo;t have to know. We can just trust the <code>t</code>&nbsp;object to do its job.&nbsp;<a class="arrow" href="#fnref-6_7">&uarr;</a></li>
<li id="fn-6_8">We&rsquo;ll see how to migrate up on a remote Heroku server in <a class="ref" href="modeling-and-viewing-users-two#sec-heroku_deploy">Section&nbsp;7.4.2</a>.&nbsp;<a class="arrow" href="#fnref-6_8">&uarr;</a></li>
<li id="fn-6_9">Officially pronounced &ldquo;ess-cue-ell-ite&rdquo;, although the (mis)pronunciation &ldquo;sequel-ite&rdquo; is also common.&nbsp;<a class="arrow" href="#fnref-6_9">&uarr;</a></li>
<li id="fn-6_10">In case you&rsquo;re curious about <code>"2010-01-05 00:57:46"</code>, I&rsquo;m not writing this after midnight; the timestamps are recorded in <a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time">Coordinated Universal Time</a> (UTC), which for most practical purposes is the same as <a href="http://en.wikipedia.org/wiki/Greenwich_Mean_Time">Greenwich Mean Time</a>. From the <a href="http://tf.nist.gov/general/misc.htm">NIST Time and Frequency FAQ</a>:   <strong>Q:</strong> Why is UTC used as the acronym for Coordinated Universal Time instead of CUT? <strong>A:</strong> In 1970 the Coordinated Universal Time system was devised by an international advisory group of technical experts within the International Telecommunication Union (ITU). The ITU felt it was best to designate a single abbreviation for use in all languages in order to minimize confusion. Since unanimous agreement could not be achieved on using either the English word order, CUT, or the French word order, TUC, the acronym UTC was chosen as a compromise.&nbsp;<a class="arrow" href="#fnref-6_10">&uarr;</a></li>
<li id="fn-6_11">Note the value of <code>user.updated_at</code>. Told you the timestamp was in UTC.&nbsp;<a class="arrow" href="#fnref-6_11">&uarr;</a></li>
<li id="fn-6_12">Exceptions and exception handling are somewhat advanced Ruby subjects, and we won&rsquo;t need them much in this book. They are important, though, and I suggest learning about them using one of the Ruby books recommended in <a class="ref" href="beginning#sec-comments_for_various_readers">Section&nbsp;1.1.1</a>.&nbsp;<a class="arrow" href="#fnref-6_12">&uarr;</a></li>
<li id="fn-6_13">To those worried that <code>find_by_email</code> will be inefficient if there are a large number of users, you&rsquo;re ahead of the game. We&rsquo;ll cover this issue, and its solution via database indices, in <a class="ref" href="modeling-and-viewing-users-one#sec-uniqueness_validation">Section&nbsp;6.2.4</a>.&nbsp;<a class="arrow" href="#fnref-6_13">&uarr;</a></li>
<li id="fn-6_14">(and written)&nbsp;<a class="arrow" href="#fnref-6_14">&uarr;</a></li>
<li id="fn-6_15">I&rsquo;ll omit the output of console commands when they are not particularly instructive&mdash;for example, the results of <code>User.new</code>.&nbsp;<a class="arrow" href="#fnref-6_15">&uarr;</a></li>
<li id="fn-6_16">Note that, in <a class="ref" href="modeling-and-viewing-users-one#table-email_regex">Table&nbsp;6.1</a>, &ldquo;letter&rdquo; really means &ldquo;lower-case letter&rdquo;, but the <code>i</code> at the end of the regex enforces case-insensitive matching.&nbsp;<a class="arrow" href="#fnref-6_16">&uarr;</a></li>
<li id="fn-6_17">If you find it as useful as I do, I encourage you to <a href="http://bit.ly/donate-to-rubular">donate to Rubular</a> to reward developer <a href="http://lovitt.net/">Michael Lovitt</a> for his wonderful work.&nbsp;<a class="arrow" href="#fnref-6_17">&uarr;</a></li>
<li id="fn-6_18">Did you know that <code>"Michael Hartl"@example.com</code>, with quotation marks and a space in the middle, is a valid email address according to the standard? Incredibly, it is&mdash;but it&rsquo;s absurd. If you don&rsquo;t have an email address that contains only letters, numbers, underscores, and dots, then get one. N.B. The regex in <a class="ref" href="modeling-and-viewing-users-one#code-validates_format_of_email">Listing&nbsp;6.17</a> allows plus signs, too, because Gmail (and possibly other email services) does something useful with them:  for example, to filter orders from Amazon, you can use <tt>username+amazon@gmail.com</tt>, which will go to the Gmail address <tt>username@gmail.com</tt>, allowing you to filter on the string <tt>amazon</tt>.&nbsp;<a class="arrow" href="#fnref-6_18">&uarr;</a></li>
<li id="fn-6_19">As noted briefly in the introduction to this section, there is a dedicated test database, <code>db/test.sqlite3</code>, for this purpose.&nbsp;<a class="arrow" href="#fnref-6_19">&uarr;</a></li>
<li id="fn-6_20">If you&rsquo;re wondering why the <code>create!</code> line in <a class="ref" href="modeling-and-viewing-users-one#code-raw_user_spec">Listing&nbsp;6.10</a> doesn&rsquo;t cause this to fail by creating a duplicate user, it&rsquo;s because Rails tests are <em>transactional</em>: each test is wrapped in a <a href="http://en.wikipedia.org/wiki/Database_transaction">transaction</a>, which <em>rolls back</em> the database after the test executes. This way, each test runs against a fresh database.&nbsp;<a class="arrow" href="#fnref-6_20">&uarr;</a></li>
<li id="fn-6_21">Yes, it happened to me. How do you think I found out about this issue?&nbsp;<a class="arrow" href="#fnref-6_21">&uarr;</a></li>
<li id="fn-6_22">Of course, we could just edit the migration file for the <code>users</code> table in <a class="ref" href="modeling-and-viewing-users-one#code-users_migration">Listing&nbsp;6.2</a> but that would require rolling back and then migrating back up. The Rails Way is to use migrations every time we discover that our data model needs to change.&nbsp;<a class="arrow" href="#fnref-6_22">&uarr;</a></li>
<li id="fn-6_23">You can define your own custom environments as well; see the <a href="http://railscasts.com/episodes/72-adding-an-environment">Railscast on adding an environment</a> for details.&nbsp;<a class="arrow" href="#fnref-6_23">&uarr;</a></li>
<li id="fn-6_24">Fielding, Roy Thomas. <em>Architectural Styles and the Design of Network-based Software Architectures</em>. Doctoral dissertation, University of California, Irvine, 2000.&nbsp;<a class="arrow" href="#fnref-6_24">&uarr;</a></li>
<li id="fn-6_25">This means that the <em>routing</em> works, but the corresponding pages don&rsquo;t necessarily work at this point. For example, <tt>/users/1/edit</tt> gets routed properly to the <code>edit</code> action of the Users controller, but since the <code>edit</code> action doesn&rsquo;t exist yet actually hitting that URL will return an error.&nbsp;<a class="arrow" href="#fnref-6_25">&uarr;</a></li>
<li id="fn-6_26">Some of this tutorial&rsquo;s screenshots show debug information with output like <code>!map:HashWithIndifferentAccess</code> instead of <code>!map:ActiveSupport::HashWithIndifferentAccess</code>. This is simply a minor difference between Rails&nbsp;2.3 and Rails&nbsp;3. Since the rendered web pages are otherwise identical between Rails versions, this one footnote saves me the trouble of redoing all the screenshots.&nbsp;<a class="arrow" href="#fnref-6_26">&uarr;</a></li>
<li id="fn-6_27">The Rails <code>debug</code> information is shown as <a href="http://www.yaml.org/">YAML</a> (a <a href="http://catb.org/jargon/html/R/recursive-acronym.html">recursive acronym</a> standing for &ldquo;YAML Ain&rsquo;t Markup Language&rdquo;), which is a friendly data format designed to be both machine- <em>and</em> human-readable.&nbsp;<a class="arrow" href="#fnref-6_27">&uarr;</a></li>
</ol>
</div>




</div>
  </body>
</html>